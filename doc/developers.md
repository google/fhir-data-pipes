# Developer Tips

## Generate the OpenMRS Docker Image

The following steps are used to generate the openmrs docker image bundled with
modules required for this project

1.  Setup latest OpenMrs distro locally:

    ```
    mvn openmrs-sdk:setup -DserverId=openmrs-analytics
    ```

2.  Add latest versions of
    [fhir2](https://addons.openmrs.org/show/org.openmrs.module.openmrs-fhir2-module)
    and [atom feed](https://addons.openmrs.org/show/org.openmrs.module.atomfeed)
    modules and ensure everything is running as expected.

3.  Generate docker image setup using openmrs SDK, this step requires you to
    provide openmrs-distro.properties file path of your openmrs instance.

    ```
    mvn openmrs-sdk:build-distro -Ddistro=/{path}/openmrs-distro.properties`
    ```

    A folder named `docker` is generated which contains a Dockerfile and other
    setup files. Example of
    [docker file](https://github.com/jecihjoy/openmrs-docker-sdk/blob/master/web/Dockerfile)
    generated by openmrs-sdk.

4.  Build the docker image:

    ```
    cd openmrs-analytics/web docker build -t
    openmrs/openmrs-reference-application-distro:analytics .
    ```

5.  Push this image to docker hub `docker push
    openmrs/openmrs-reference-application-distro:analytics`

## Debezium development

When working on a feature in the Debezium based pipeline, you can replay old
binlog updates by setting the system properties `database.offsetStorage` and
`database.databaseHistory` to an old version of the history. In other words, you
can start from history/offset pair A, add some events in OpenMRS (e.g., add an
Observation) to create some updates in the binlog. Now if you keep a copy of
original version of A (before the changes) you can reuse it in future runs to
replay the new events with no more interactions with OpenMRS.

## Running end-to-end tests

When a Pull Request is submitted, it triggers a request to Google-owned project running [Cloud Build](https://cloud.google.com/build) to run the build config file defined in [`cloudbuild.yaml`](../cloudbuild.yaml). The CI pipeline can also be run locally, using the Cloud Build local builder. To setup the local builder, follow the instructions [here](https://cloud.google.com/build/docs/build-debug-locally); you will need Docker, and the Google Cloud SDK to install the local builder. Once the local builder is installed, do the following:

1. Stop any running `openmrs`, `openmrs-fhir-mysql`, and `sink-server` containers by running:

    ```bash
    docker stop sink-server openmrs openmrs-fhir-mysql
    ```

2. Run the e2e-test using the local builder:

    ```bash
    cloud-build-local  --dryrun=false .
    ```