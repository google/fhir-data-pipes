[{
  "title": "logic",
  "resources": [
    {
      "resourceType": "Patient",
      "id": "m0",
      "gender": "male",
      "deceasedBoolean": false
    },
    {
      "resourceType": "Patient",
      "id": "f0",
      "deceasedBoolean": false,
      "gender": "female"
    },
    {
      "resourceType": "Patient",
      "id": "m1",
      "gender": "male",
      "deceasedBoolean": true
    },
    {
      "resourceType": "Patient",
      "id": "f1",
      "gender": "female"
    }
  ],
  "tests": [
    {
      "title": "filtering with 'and'",
      "view": {
        "resource": "Patient",
        "select": [
          {
            "column": [
              {
                "path": "id",
                "name": "id",
                "type": "id",
                "collection": false,
                "inferredCollection": false
              }
            ]
          }
        ],
        "where": [
          {
            "path": "gender = 'male' and deceased.ofType(boolean) = false"
          }
        ],
        "constMap": {},
        "allColumns": {
          "id": {
            "path": "id",
            "name": "id",
            "type": "id",
            "collection": false,
            "inferredCollection": false
          }
        }
      },
      "expect": [
        {
          "id": "m0"
        }
      ],
      "result": {
        "passed": true
      }
    },
    {
      "title": "filtering with 'or'",
      "view": {
        "resource": "Patient",
        "select": [
          {
            "column": [
              {
                "path": "id",
                "name": "id",
                "type": "id",
                "collection": false,
                "inferredCollection": false
              }
            ]
          }
        ],
        "where": [
          {
            "path": "gender = 'male' or deceased.ofType(boolean) = false"
          }
        ],
        "constMap": {},
        "allColumns": {
          "id": {
            "path": "id",
            "name": "id",
            "type": "id",
            "collection": false,
            "inferredCollection": false
          }
        }
      },
      "expect": [
        {
          "id": "m0"
        },
        {
          "id": "f0"
        },
        {
          "id": "m1"
        }
      ],
      "result": {
        "passed": true
      }
    },
    {
      "title": "filtering with 'not'",
      "view": {
        "resource": "Patient",
        "select": [
          {
            "column": [
              {
                "path": "id",
                "name": "id",
                "type": "id",
                "collection": false,
                "inferredCollection": false
              }
            ]
          }
        ],
        "where": [
          {
            "path": "(gender = 'male').not()"
          }
        ],
        "constMap": {},
        "allColumns": {
          "id": {
            "path": "id",
            "name": "id",
            "type": "id",
            "collection": false,
            "inferredCollection": false
          }
        }
      },
      "expect": [
        {
          "id": "f0"
        },
        {
          "id": "f1"
        }
      ],
      "result": {
        "passed": true
      }
    }
  ]
},
{
  "title": "fn_join",
  "resources": [
    {
      "resourceType": "Patient",
      "id": "p1",
      "name": [
        {
          "use": "official",
          "given": [
            "p1.g1",
            "p1.g2"
          ]
        }
      ]
    }
  ],
  "tests": [
    {
      "title": "join with comma",
      "view": {
        "resource": "Patient",
        "select": [
          {
            "column": [
              {
                "path": "id",
                "name": "id",
                "type": "id",
                "collection": false,
                "inferredCollection": false
              },
              {
                "path": "name.given.join(',')",
                "name": "given",
                "type": "string",
                "collection": false,
                "inferredCollection": false
              }
            ]
          }
        ],
        "constMap": {},
        "allColumns": {
          "id": {
            "path": "id",
            "name": "id",
            "type": "id",
            "collection": false,
            "inferredCollection": false
          },
          "given": {
            "path": "name.given.join(',')",
            "name": "given",
            "type": "string",
            "collection": false,
            "inferredCollection": false
          }
        }
      },
      "expect": [
        {
          "id": "p1",
          "given": "p1.g1,p1.g2"
        }
      ],
      "result": {
        "passed": true
      }
    },
    {
      "title": "join with empty value",
      "view": {
        "resource": "Patient",
        "select": [
          {
            "column": [
              {
                "path": "id",
                "name": "id",
                "type": "id",
                "collection": false,
                "inferredCollection": false
              },
              {
                "path": "name.given.join('')",
                "name": "given",
                "type": "string",
                "collection": false,
                "inferredCollection": false
              }
            ]
          }
        ],
        "constMap": {},
        "allColumns": {
          "id": {
            "path": "id",
            "name": "id",
            "type": "id",
            "collection": false,
            "inferredCollection": false
          },
          "given": {
            "path": "name.given.join('')",
            "name": "given",
            "type": "string",
            "collection": false,
            "inferredCollection": false
          }
        }
      },
      "expect": [
        {
          "id": "p1",
          "given": "p1.g1p1.g2"
        }
      ],
      "result": {
        "passed": true
      }
    },
    {
      "title": "join with no value - default to no separator",
      "view": {
        "resource": "Patient",
        "select": [
          {
            "column": [
              {
                "path": "id",
                "name": "id",
                "type": "id",
                "collection": false,
                "inferredCollection": false
              },
              {
                "path": "name.given.join()",
                "name": "given",
                "type": "name",
                "collection": false,
                "inferredCollection": false
              }
            ]
          }
        ],
        "constMap": {}
      },
      "expect": [
        {
          "id": "p1",
          "given": "p1.g1p1.g2"
        }
      ],
      "result": {
        "passed": false,
        "failureReason": "skipped"
      }
    }
  ]
},
{
  "title": "fhirpath",
  "resources": [
    {
      "resourceType": "Patient",
      "id": "pt1",
      "managingOrganization": {
        "reference": "Organization/o1"
      },
      "name": [
        {
          "family": "f1.1",
          "use": "official",
          "given": [
            "g1.1.1",
            "g1.1.2"
          ]
        },
        {
          "family": "f1.2",
          "given": [
            "g1.2.1"
          ]
        }
      ],
      "active": true
    },
    {
      "resourceType": "Patient",
      "id": "pt2",
      "managingOrganization": {
        "reference": "http://myapp.com/prefix/Organization/o2"
      },
      "name": [
        {
          "family": "f2.1"
        },
        {
          "family": "f2.2",
          "use": "official"
        }
      ],
      "active": false
    },
    {
      "resourceType": "Patient",
      "id": "pt3"
    }
  ],
  "tests": [
    {
      "title": "one element",
      "view": {
        "resource": "Patient",
        "select": [
          {
            "column": [
              {
                "path": "id",
                "name": "id",
                "type": "id",
                "collection": false,
                "inferredCollection": false
              }
            ]
          }
        ],
        "constMap": {},
        "allColumns": {
          "id": {
            "path": "id",
            "name": "id",
            "type": "id",
            "collection": false,
            "inferredCollection": false
          }
        }
      },
      "expect": [
        {
          "id": "pt1"
        },
        {
          "id": "pt2"
        },
        {
          "id": "pt3"
        }
      ],
      "result": {
        "passed": true
      }
    },
    {
      "title": "two elements + first",
      "view": {
        "resource": "Patient",
        "select": [
          {
            "column": [
              {
                "path": "name.family.first()",
                "name": "v",
                "type": "string",
                "collection": false,
                "inferredCollection": false
              }
            ]
          }
        ],
        "constMap": {},
        "allColumns": {
          "v": {
            "path": "name.family.first()",
            "name": "v",
            "type": "string",
            "collection": false,
            "inferredCollection": false
          }
        }
      },
      "expect": [
        {
          "v": "f1.1"
        },
        {
          "v": "f2.1"
        },
        {}
      ],
      "result": {
        "passed": true
      }
    },
    {
      "title": "collection",
      "view": {
        "resource": "Patient",
        "select": [
          {
            "column": [
              {
                "path": "name.family",
                "name": "v",
                "type": "string",
                "collection": true,
                "inferredCollection": false
              }
            ]
          }
        ],
        "constMap": {},
        "allColumns": {
          "v": {
            "path": "name.family",
            "name": "v",
            "type": "string",
            "collection": true,
            "inferredCollection": false
          }
        }
      },
      "expect": [
        {
          "v": [
            "f1.1",
            "f1.2"
          ]
        },
        {
          "v": [
            "f2.1",
            "f2.2"
          ]
        },
        {
          "v": []
        }
      ],
      "result": {
        "passed": true
      }
    },
    {
      "title": "index[0]",
      "view": {
        "resource": "Patient",
        "select": [
          {
            "column": [
              {
                "path": "name[0].family",
                "name": "v",
                "type": "string",
                "collection": false,
                "inferredCollection": false
              }
            ]
          }
        ],
        "constMap": {},
        "allColumns": {
          "v": {
            "path": "name[0].family",
            "name": "v",
            "type": "string",
            "collection": false,
            "inferredCollection": false
          }
        }
      },
      "expect": [
        {
          "v": "f1.1"
        },
        {
          "v": "f2.1"
        },
        {}
      ],
      "result": {
        "passed": true
      }
    },
    {
      "title": "index[1]",
      "view": {
        "resource": "Patient",
        "select": [
          {
            "column": [
              {
                "path": "name[1].family",
                "name": "v",
                "type": "string",
                "collection": false,
                "inferredCollection": false
              }
            ]
          }
        ],
        "constMap": {},
        "allColumns": {
          "v": {
            "path": "name[1].family",
            "name": "v",
            "type": "string",
            "collection": false,
            "inferredCollection": false
          }
        }
      },
      "expect": [
        {
          "v": "f1.2"
        },
        {
          "v": "f2.2"
        },
        {}
      ],
      "result": {
        "passed": true
      }
    },
    {
      "title": "out of index",
      "view": {
        "resource": "Patient",
        "select": [
          {
            "column": [
              {
                "path": "name[2].family",
                "name": "v",
                "type": "string",
                "collection": false,
                "inferredCollection": false
              }
            ]
          }
        ],
        "constMap": {},
        "allColumns": {
          "v": {
            "path": "name[2].family",
            "name": "v",
            "type": "string",
            "collection": false,
            "inferredCollection": false
          }
        }
      },
      "expect": [
        {},
        {},
        {}
      ],
      "result": {
        "passed": true
      }
    },
    {
      "title": "where",
      "view": {
        "resource": "Patient",
        "select": [
          {
            "column": [
              {
                "path": "name.where(use='official').family",
                "name": "v",
                "type": "string",
                "collection": false,
                "inferredCollection": false
              }
            ]
          }
        ],
        "constMap": {},
        "allColumns": {
          "v": {
            "path": "name.where(use='official').family",
            "name": "v",
            "type": "string",
            "collection": false,
            "inferredCollection": false
          }
        }
      },
      "expect": [
        {
          "v": "f1.1"
        },
        {
          "v": "f2.2"
        },
        {}
      ],
      "result": {
        "passed": true
      }
    },
    {
      "title": "exists",
      "view": {
        "resource": "Patient",
        "select": [
          {
            "column": [
              {
                "path": "id",
                "name": "id",
                "type": "id",
                "collection": false,
                "inferredCollection": false
              },
              {
                "path": "name.exists()",
                "name": "has_name",
                "type": "boolean",
                "collection": false,
                "inferredCollection": false
              }
            ]
          }
        ],
        "constMap": {},
        "allColumns": {
          "id": {
            "path": "id",
            "name": "id",
            "type": "id",
            "collection": false,
            "inferredCollection": false
          },
          "has_name": {
            "path": "name.exists()",
            "name": "has_name",
            "type": "boolean",
            "collection": false,
            "inferredCollection": false
          }
        }
      },
      "expect": [
        {
          "id": "pt1",
          "has_name": true
        },
        {
          "id": "pt2",
          "has_name": true
        },
        {
          "id": "pt3",
          "has_name": false
        }
      ],
      "result": {
        "passed": true
      }
    },
    {
      "title": "nested exists",
      "view": {
        "resource": "Patient",
        "select": [
          {
            "column": [
              {
                "path": "id",
                "name": "id",
                "type": "id",
                "collection": false,
                "inferredCollection": false
              },
              {
                "path": "name.given.exists()",
                "name": "has_given",
                "type": "boolean",
                "collection": false,
                "inferredCollection": false
              }
            ]
          }
        ],
        "constMap": {},
        "allColumns": {
          "id": {
            "path": "id",
            "name": "id",
            "type": "id",
            "collection": false,
            "inferredCollection": false
          },
          "has_given": {
            "path": "name.given.exists()",
            "name": "has_given",
            "type": "boolean",
            "collection": false,
            "inferredCollection": false
          }
        }
      },
      "expect": [
        {
          "id": "pt1",
          "has_given": true
        },
        {
          "id": "pt2",
          "has_given": false
        },
        {
          "id": "pt3",
          "has_given": false
        }
      ],
      "result": {
        "passed": true
      }
    },
    {
      "title": "string join",
      "view": {
        "resource": "Patient",
        "select": [
          {
            "column": [
              {
                "path": "id",
                "name": "id",
                "type": "id",
                "collection": false,
                "inferredCollection": false
              },
              {
                "path": "name.given.join(', ' )",
                "name": "given",
                "type": "string",
                "collection": false,
                "inferredCollection": false
              }
            ]
          }
        ],
        "constMap": {},
        "allColumns": {
          "id": {
            "path": "id",
            "name": "id",
            "type": "id",
            "collection": false,
            "inferredCollection": false
          },
          "given": {
            "path": "name.given.join(', ' )",
            "name": "given",
            "type": "string",
            "collection": false,
            "inferredCollection": false
          }
        }
      },
      "expect": [
        {
          "id": "pt1",
          "given": "g1.1.1, g1.1.2, g1.2.1"
        },
        {
          "id": "pt2",
          "given": ""
        },
        {
          "id": "pt3",
          "given": ""
        }
      ],
      "result": {
        "passed": true
      }
    },
    {
      "title": "string join: default separator",
      "view": {
        "resource": "Patient",
        "select": [
          {
            "column": [
              {
                "path": "id",
                "name": "id",
                "type": "id",
                "collection": false,
                "inferredCollection": false
              },
              {
                "path": "name.given.join()",
                "name": "given",
                "type": "string",
                "collection": false,
                "inferredCollection": false
              }
            ]
          }
        ],
        "constMap": {}
      },
      "expect": [
        {
          "id": "pt1",
          "given": "g1.1.1g1.1.2g1.2.1"
        },
        {
          "id": "pt2",
          "given": ""
        },
        {
          "id": "pt3",
          "given": ""
        }
      ],
      "result": {
        "passed": false,
        "failureReason": "skipped"
      }
    }
  ]
},
{
  "title": "fn_oftype",
  "resources": [
    {
      "resourceType": "Observation",
      "id": "o1",
      "code": {
        "text": "code"
      },
      "status": "final",
      "valueString": "foo"
    },
    {
      "resourceType": "Observation",
      "id": "o2",
      "code": {
        "text": "code"
      },
      "status": "final",
      "valueInteger": 42
    },
    {
      "resourceType": "Observation",
      "id": "o3",
      "code": {
        "text": "code"
      },
      "status": "final"
    }
  ],
  "tests": [
    {
      "title": "select string values",
      "view": {
        "resource": "Observation",
        "select": [
          {
            "column": [
              {
                "path": "id",
                "name": "id",
                "type": "id",
                "collection": false,
                "inferredCollection": false
              },
              {
                "path": "value.ofType(string)",
                "name": "string_value",
                "type": "string",
                "collection": false,
                "inferredCollection": false
              }
            ]
          }
        ],
        "constMap": {},
        "allColumns": {
          "id": {
            "path": "id",
            "name": "id",
            "type": "id",
            "collection": false,
            "inferredCollection": false
          },
          "string_value": {
            "path": "value.ofType(string)",
            "name": "string_value",
            "type": "string",
            "collection": false,
            "inferredCollection": false
          }
        }
      },
      "expect": [
        {
          "id": "o1",
          "string_value": "foo"
        },
        {
          "id": "o2"
        },
        {
          "id": "o3"
        }
      ],
      "result": {
        "passed": true
      }
    },
    {
      "title": "select integer values",
      "view": {
        "resource": "Observation",
        "select": [
          {
            "column": [
              {
                "path": "id",
                "name": "id",
                "type": "id",
                "collection": false,
                "inferredCollection": false
              },
              {
                "path": "value.ofType(integer)",
                "name": "integer_value",
                "type": "integer",
                "collection": false,
                "inferredCollection": false
              }
            ]
          }
        ],
        "constMap": {},
        "allColumns": {
          "id": {
            "path": "id",
            "name": "id",
            "type": "id",
            "collection": false,
            "inferredCollection": false
          },
          "integer_value": {
            "path": "value.ofType(integer)",
            "name": "integer_value",
            "type": "integer",
            "collection": false,
            "inferredCollection": false
          }
        }
      },
      "expect": [
        {
          "id": "o1"
        },
        {
          "id": "o2",
          "integer_value": 42
        },
        {
          "id": "o3"
        }
      ],
      "result": {
        "passed": true
      }
    }
  ]
},
{
  "title": "fn_extension",
  "resources": [
    {
      "resourceType": "Patient",
      "id": "pt1",
      "meta": {
        "profile": [
          "http://hl7.org/fhir/us/core/StructureDefinition/us-core-patient"
        ]
      },
      "extension": [
        {
          "id": "birthsex",
          "url": "http://hl7.org/fhir/us/core/StructureDefinition/us-core-birthsex",
          "valueCode": "F"
        },
        {
          "id": "race",
          "url": "http://hl7.org/fhir/us/core/StructureDefinition/us-core-race",
          "extension": [
            {
              "url": "ombCategory",
              "valueCoding": {
                "system": "urn:oid:2.16.840.1.113883.6.238",
                "code": "2106-3",
                "display": "White"
              }
            },
            {
              "url": "text",
              "valueString": "Mixed"
            }
          ]
        },
        {
          "id": "sex",
          "url": "http://hl7.org/fhir/us/core/StructureDefinition/us-core-sex",
          "valueCode": "248152002"
        }
      ]
    },
    {
      "resourceType": "Patient",
      "id": "pt2",
      "meta": {
        "profile": [
          "http://hl7.org/fhir/us/core/StructureDefinition/us-core-patient"
        ]
      },
      "extension": [
        {
          "id": "birthsex",
          "url": "http://hl7.org/fhir/us/core/StructureDefinition/us-core-birthsex",
          "valueCode": "M"
        },
        {
          "url": "http://hl7.org/fhir/us/core/StructureDefinition/us-core-race",
          "id": "race",
          "extension": [
            {
              "url": "ombCategory",
              "valueCoding": {
                "system": "urn:oid:2.16.840.1.113883.6.238",
                "code": "2135-2",
                "display": "Hispanic or Latino"
              }
            },
            {
              "url": "text",
              "valueString": "Mixed"
            }
          ]
        },
        {
          "id": "sex",
          "url": "http://hl7.org/fhir/us/core/StructureDefinition/us-core-sex",
          "valueCode": "248152002"
        }
      ]
    },
    {
      "resourceType": "Patient",
      "id": "pt3",
      "meta": {
        "profile": [
          "http://hl7.org/fhir/us/core/StructureDefinition/us-core-patient"
        ]
      },
      "extension": []
    }
  ],
  "tests": [
    {
      "title": "simple extension",
      "view": {
        "resource": "Patient",
        "select": [
          {
            "column": [
              {
                "path": "id",
                "name": "id",
                "type": "id",
                "collection": false,
                "inferredCollection": false
              },
              {
                "path": "extension('http://hl7.org/fhir/us/core/StructureDefinition/us-core-birthsex').value.ofType(code).first()",
                "name": "birthsex",
                "type": "code",
                "collection": false,
                "inferredCollection": false
              }
            ]
          }
        ],
        "constMap": {},
        "allColumns": {
          "id": {
            "path": "id",
            "name": "id",
            "type": "id",
            "collection": false,
            "inferredCollection": false
          },
          "birthsex": {
            "path": "extension('http://hl7.org/fhir/us/core/StructureDefinition/us-core-birthsex').value.ofType(code).first()",
            "name": "birthsex",
            "type": "code",
            "collection": false,
            "inferredCollection": false
          }
        }
      },
      "expect": [
        {
          "id": "pt1",
          "birthsex": "F"
        },
        {
          "id": "pt2",
          "birthsex": "M"
        },
        {
          "id": "pt3"
        }
      ],
      "result": {
        "passed": true
      }
    },
    {
      "title": "nested extension",
      "view": {
        "resource": "Patient",
        "select": [
          {
            "column": [
              {
                "path": "id",
                "name": "id",
                "type": "id",
                "collection": false,
                "inferredCollection": false
              },
              {
                "path": "extension('http://hl7.org/fhir/us/core/StructureDefinition/us-core-race').extension('ombCategory').value.ofType(Coding).code.first()",
                "name": "race_code",
                "type": "code",
                "collection": false,
                "inferredCollection": false
              }
            ]
          }
        ],
        "constMap": {},
        "allColumns": {
          "id": {
            "path": "id",
            "name": "id",
            "type": "id",
            "collection": false,
            "inferredCollection": false
          },
          "race_code": {
            "path": "extension('http://hl7.org/fhir/us/core/StructureDefinition/us-core-race').extension('ombCategory').value.ofType(Coding).code.first()",
            "name": "race_code",
            "type": "code",
            "collection": false,
            "inferredCollection": false
          }
        }
      },
      "expect": [
        {
          "id": "pt1",
          "race_code": "2106-3"
        },
        {
          "id": "pt2",
          "race_code": "2135-2"
        },
        {
          "id": "pt3"
        }
      ],
      "result": {
        "passed": true
      }
    }
  ]
},
{
  "title": "fn_boundary",
  "resources": [
    {
      "resourceType": "Observation",
      "id": "o1",
      "code": {
        "text": "code"
      },
      "status": "final",
      "valueQuantity": {
        "value": 1.0
      }
    },
    {
      "resourceType": "Observation",
      "id": "o2",
      "code": {
        "text": "code"
      },
      "status": "final",
      "valueDateTime": "2010-10-10"
    },
    {
      "resourceType": "Observation",
      "id": "o3",
      "code": {
        "text": "code"
      },
      "status": "final"
    },
    {
      "resourceType": "Observation",
      "id": "o4",
      "code": {
        "text": "code"
      },
      "valueTime": "12:34"
    },
    {
      "resourceType": "Patient",
      "id": "p1",
      "birthDate": "1970-06"
    }
  ],
  "tests": [
    {
      "title": "decimal lowBoundary",
      "view": {
        "resource": "Observation",
        "select": [
          {
            "column": [
              {
                "path": "id",
                "name": "id",
                "type": "id",
                "collection": false,
                "inferredCollection": false
              },
              {
                "path": "value.ofType(Quantity).value.lowBoundary()",
                "name": "decimal",
                "type": "decimal",
                "collection": false,
                "inferredCollection": false
              }
            ]
          }
        ],
        "constMap": {},
        "allColumns": {
          "id": {
            "path": "id",
            "name": "id",
            "type": "id",
            "collection": false,
            "inferredCollection": false
          },
          "decimal": {
            "path": "value.ofType(Quantity).value.lowBoundary()",
            "name": "decimal",
            "type": "decimal",
            "collection": false,
            "inferredCollection": false
          }
        }
      },
      "expect": [
        {
          "id": "o1",
          "decimal": 0.95
        },
        {
          "id": "o2"
        },
        {
          "id": "o3"
        },
        {
          "id": "o4"
        }
      ],
      "result": {
        "passed": true
      }
    },
    {
      "title": "decimal highBoundary",
      "view": {
        "resource": "Observation",
        "select": [
          {
            "column": [
              {
                "path": "id",
                "name": "id",
                "type": "id",
                "collection": false,
                "inferredCollection": false
              },
              {
                "path": "value.ofType(Quantity).value.highBoundary()",
                "name": "decimal",
                "type": "decimal",
                "collection": false,
                "inferredCollection": false
              }
            ]
          }
        ],
        "constMap": {},
        "allColumns": {
          "id": {
            "path": "id",
            "name": "id",
            "type": "id",
            "collection": false,
            "inferredCollection": false
          },
          "decimal": {
            "path": "value.ofType(Quantity).value.highBoundary()",
            "name": "decimal",
            "type": "decimal",
            "collection": false,
            "inferredCollection": false
          }
        }
      },
      "expect": [
        {
          "id": "o1",
          "decimal": 1.05
        },
        {
          "id": "o2"
        },
        {
          "id": "o3"
        },
        {
          "id": "o4"
        }
      ],
      "result": {
        "passed": true
      }
    },
    {
      "title": "datetime lowBoundary",
      "view": {
        "resource": "Observation",
        "select": [
          {
            "column": [
              {
                "path": "id",
                "name": "id",
                "type": "id",
                "collection": false,
                "inferredCollection": false
              },
              {
                "path": "value.ofType(dateTime).lowBoundary()",
                "name": "datetime",
                "type": "dateTime",
                "collection": false,
                "inferredCollection": false
              }
            ]
          }
        ],
        "constMap": {},
        "allColumns": {
          "id": {
            "path": "id",
            "name": "id",
            "type": "id",
            "collection": false,
            "inferredCollection": false
          },
          "datetime": {
            "path": "value.ofType(dateTime).lowBoundary()",
            "name": "datetime",
            "type": "dateTime",
            "collection": false,
            "inferredCollection": false
          }
        }
      },
      "expect": [
        {
          "id": "o1"
        },
        {
          "id": "o2",
          "datetime": "2010-10-10T00:00:00.000+14:00"
        },
        {
          "id": "o3"
        },
        {
          "id": "o4"
        }
      ],
      "result": {
        "passed": true
      }
    },
    {
      "title": "datetime highBoundary",
      "view": {
        "resource": "Observation",
        "select": [
          {
            "column": [
              {
                "path": "id",
                "name": "id",
                "type": "id",
                "collection": false,
                "inferredCollection": false
              },
              {
                "path": "value.ofType(dateTime).highBoundary()",
                "name": "datetime",
                "type": "dateTime",
                "collection": false,
                "inferredCollection": false
              }
            ]
          }
        ],
        "constMap": {},
        "allColumns": {
          "id": {
            "path": "id",
            "name": "id",
            "type": "id",
            "collection": false,
            "inferredCollection": false
          },
          "datetime": {
            "path": "value.ofType(dateTime).highBoundary()",
            "name": "datetime",
            "type": "dateTime",
            "collection": false,
            "inferredCollection": false
          }
        }
      },
      "expect": [
        {
          "id": "o1"
        },
        {
          "id": "o2",
          "datetime": "2010-10-10T23:59:59.999-12:00"
        },
        {
          "id": "o3"
        },
        {
          "id": "o4"
        }
      ],
      "result": {
        "passed": true
      }
    },
    {
      "title": "date lowBoundary",
      "view": {
        "resource": "Patient",
        "select": [
          {
            "column": [
              {
                "path": "id",
                "name": "id",
                "type": "id",
                "collection": false,
                "inferredCollection": false
              },
              {
                "path": "birthDate.lowBoundary()",
                "name": "date",
                "type": "date",
                "collection": false,
                "inferredCollection": false
              }
            ]
          }
        ],
        "constMap": {}
      },
      "expect": [
        {
          "id": "p1",
          "date": "1970-06-01"
        }
      ],
      "result": {
        "passed": false,
        "failureReason": "skipped"
      }
    },
    {
      "title": "date highBoundary",
      "view": {
        "resource": "Patient",
        "select": [
          {
            "column": [
              {
                "path": "id",
                "name": "id",
                "type": "id",
                "collection": false,
                "inferredCollection": false
              },
              {
                "path": "birthDate.highBoundary()",
                "name": "date",
                "type": "date",
                "collection": false,
                "inferredCollection": false
              }
            ]
          }
        ],
        "constMap": {}
      },
      "expect": [
        {
          "id": "p1",
          "date": "1970-06-30"
        }
      ],
      "result": {
        "passed": false,
        "failureReason": "skipped"
      }
    },
    {
      "title": "time lowBoundary",
      "view": {
        "resource": "Observation",
        "select": [
          {
            "column": [
              {
                "path": "id",
                "name": "id",
                "type": "id",
                "collection": false,
                "inferredCollection": false
              },
              {
                "path": "value.ofType(time).lowBoundary()",
                "name": "time",
                "type": "time",
                "collection": false,
                "inferredCollection": false
              }
            ]
          }
        ],
        "constMap": {},
        "allColumns": {
          "id": {
            "path": "id",
            "name": "id",
            "type": "id",
            "collection": false,
            "inferredCollection": false
          },
          "time": {
            "path": "value.ofType(time).lowBoundary()",
            "name": "time",
            "type": "time",
            "collection": false,
            "inferredCollection": false
          }
        }
      },
      "expect": [
        {
          "id": "o1"
        },
        {
          "id": "o2"
        },
        {
          "id": "o3"
        },
        {
          "id": "o4",
          "time": "12:34:00.000"
        }
      ],
      "result": {
        "passed": true
      }
    },
    {
      "title": "time highBoundary",
      "view": {
        "resource": "Observation",
        "select": [
          {
            "column": [
              {
                "path": "id",
                "name": "id",
                "type": "id",
                "collection": false,
                "inferredCollection": false
              },
              {
                "path": "value.ofType(time).highBoundary()",
                "name": "time",
                "type": "time",
                "collection": false,
                "inferredCollection": false
              }
            ]
          }
        ],
        "constMap": {},
        "allColumns": {
          "id": {
            "path": "id",
            "name": "id",
            "type": "id",
            "collection": false,
            "inferredCollection": false
          },
          "time": {
            "path": "value.ofType(time).highBoundary()",
            "name": "time",
            "type": "time",
            "collection": false,
            "inferredCollection": false
          }
        }
      },
      "expect": [
        {
          "id": "o1"
        },
        {
          "id": "o2"
        },
        {
          "id": "o3"
        },
        {
          "id": "o4",
          "time": "12:34:59.999"
        }
      ],
      "result": {
        "passed": true
      }
    }
  ]
},
{
  "title": "view_resource",
  "resources": [
    {
      "id": "pt1",
      "resourceType": "Patient"
    },
    {
      "id": "pt2",
      "resourceType": "Patient"
    },
    {
      "id": "ob1",
      "resourceType": "Observation",
      "code": {
        "text": "code"
      },
      "status": "final"
    }
  ],
  "tests": [
    {
      "title": "only pts",
      "view": {
        "resource": "Patient",
        "select": [
          {
            "column": [
              {
                "path": "id",
                "name": "id",
                "type": "id",
                "collection": false,
                "inferredCollection": false
              }
            ]
          }
        ],
        "constMap": {},
        "allColumns": {
          "id": {
            "path": "id",
            "name": "id",
            "type": "id",
            "collection": false,
            "inferredCollection": false
          }
        }
      },
      "expect": [
        {
          "id": "pt1"
        },
        {
          "id": "pt2"
        }
      ],
      "result": {
        "passed": true
      }
    },
    {
      "title": "only obs",
      "view": {
        "resource": "Observation",
        "select": [
          {
            "column": [
              {
                "path": "id",
                "name": "id",
                "type": "id",
                "collection": false,
                "inferredCollection": false
              }
            ]
          }
        ],
        "constMap": {},
        "allColumns": {
          "id": {
            "path": "id",
            "name": "id",
            "type": "id",
            "collection": false,
            "inferredCollection": false
          }
        }
      },
      "expect": [
        {
          "id": "ob1"
        }
      ],
      "result": {
        "passed": true
      }
    },
    {
      "title": "resource not specified",
      "view": {
        "select": [
          {
            "column": [
              {
                "path": "id",
                "name": "id",
                "type": "id",
                "collection": false,
                "inferredCollection": false
              }
            ]
          }
        ],
        "constMap": {}
      },
      "expectError": true
    }
  ]
},
{
  "title": "constant",
  "resources": [
    {
      "resourceType": "Patient",
      "id": "pt1",
      "name": [
        {
          "family": "Block",
          "use": "usual"
        },
        {
          "family": "Smith",
          "use": "official"
        }
      ]
    },
    {
      "resourceType": "Patient",
      "id": "pt2",
      "deceasedBoolean": true,
      "name": [
        {
          "family": "Johnson",
          "use": "usual"
        },
        {
          "family": "Menendez",
          "use": "old"
        }
      ]
    }
  ],
  "tests": [
    {
      "title": "constant in path",
      "view": {
        "resource": "Patient",
        "select": [
          {
            "column": [
              {
                "path": "id",
                "name": "id",
                "type": "id",
                "collection": false,
                "inferredCollection": false
              },
              {
                "path": "name.where(use = 'official').family",
                "name": "official_name",
                "type": "string",
                "collection": false,
                "inferredCollection": false
              }
            ]
          }
        ],
        "constant": [
          {
            "name": "name_use",
            "valueString": "official"
          }
        ],
        "constMap": {
          "name_use": "'official'"
        },
        "allColumns": {
          "id": {
            "path": "id",
            "name": "id",
            "type": "id",
            "collection": false,
            "inferredCollection": false
          },
          "official_name": {
            "path": "name.where(use = 'official').family",
            "name": "official_name",
            "type": "string",
            "collection": false,
            "inferredCollection": false
          }
        }
      },
      "expect": [
        {
          "id": "pt1",
          "official_name": "Smith"
        },
        {
          "id": "pt2"
        }
      ],
      "result": {
        "passed": true
      }
    },
    {
      "title": "constant in forEach",
      "view": {
        "resource": "Patient",
        "select": [
          {
            "column": [
              {
                "path": "family",
                "name": "official_name",
                "type": "string",
                "collection": false,
                "inferredCollection": false
              }
            ],
            "forEach": "name.where(use = 'official')"
          }
        ],
        "constant": [
          {
            "name": "name_use",
            "valueString": "official"
          }
        ],
        "constMap": {
          "name_use": "'official'"
        },
        "allColumns": {
          "official_name": {
            "path": "family",
            "name": "official_name",
            "type": "string",
            "collection": false,
            "inferredCollection": false
          }
        }
      },
      "expect": [
        {
          "official_name": "Smith"
        }
      ],
      "result": {
        "passed": true
      }
    },
    {
      "title": "constant in where element",
      "view": {
        "resource": "Patient",
        "select": [
          {
            "column": [
              {
                "path": "id",
                "name": "id",
                "type": "id",
                "collection": false,
                "inferredCollection": false
              }
            ]
          }
        ],
        "where": [
          {
            "path": "name.where(use = 'official').exists()"
          }
        ],
        "constant": [
          {
            "name": "name_use",
            "valueString": "official"
          }
        ],
        "constMap": {
          "name_use": "'official'"
        },
        "allColumns": {
          "id": {
            "path": "id",
            "name": "id",
            "type": "id",
            "collection": false,
            "inferredCollection": false
          }
        }
      },
      "expect": [
        {
          "id": "pt1"
        }
      ],
      "result": {
        "passed": true
      }
    },
    {
      "title": "constant in unionAll",
      "view": {
        "resource": "Patient",
        "select": [
          {
            "unionAll": [
              {
                "column": [
                  {
                    "path": "family",
                    "name": "name",
                    "type": "string",
                    "collection": false,
                    "inferredCollection": false
                  }
                ],
                "forEach": "name.where(use = 'official')"
              },
              {
                "column": [
                  {
                    "path": "family",
                    "name": "name",
                    "type": "string",
                    "collection": false,
                    "inferredCollection": false
                  }
                ],
                "forEach": "name.where(use = 'usual')"
              }
            ]
          }
        ],
        "constant": [
          {
            "name": "use1",
            "valueString": "official"
          },
          {
            "name": "use2",
            "valueString": "usual"
          }
        ],
        "constMap": {
          "use1": "'official'",
          "use2": "'usual'"
        },
        "allColumns": {
          "name": {
            "path": "family",
            "name": "name",
            "type": "string",
            "collection": false,
            "inferredCollection": false
          }
        }
      },
      "expect": [
        {
          "name": "Smith"
        },
        {
          "name": "Block"
        },
        {
          "name": "Johnson"
        }
      ],
      "result": {
        "passed": true
      }
    },
    {
      "title": "integer constant",
      "view": {
        "resource": "Patient",
        "select": [
          {
            "column": [
              {
                "path": "id",
                "name": "id",
                "type": "id",
                "collection": false,
                "inferredCollection": false
              },
              {
                "path": "name[1].family",
                "name": "official_name",
                "type": "string",
                "collection": false,
                "inferredCollection": false
              }
            ]
          }
        ],
        "constant": [
          {
            "name": "name_index",
            "valueInteger": 1
          }
        ],
        "constMap": {
          "name_index": "1"
        },
        "allColumns": {
          "id": {
            "path": "id",
            "name": "id",
            "type": "id",
            "collection": false,
            "inferredCollection": false
          },
          "official_name": {
            "path": "name[1].family",
            "name": "official_name",
            "type": "string",
            "collection": false,
            "inferredCollection": false
          }
        }
      },
      "expect": [
        {
          "id": "pt1",
          "official_name": "Smith"
        },
        {
          "id": "pt2",
          "official_name": "Menendez"
        }
      ],
      "result": {
        "passed": true
      }
    },
    {
      "title": "boolean constant",
      "view": {
        "resource": "Patient",
        "select": [
          {
            "column": [
              {
                "path": "id",
                "name": "id",
                "type": "id",
                "collection": false,
                "inferredCollection": false
              }
            ]
          }
        ],
        "where": [
          {
            "path": "deceased.ofType(boolean).exists() and deceased.ofType(boolean) = true"
          }
        ],
        "constant": [
          {
            "name": "is_deceased",
            "valueBoolean": true
          }
        ],
        "constMap": {
          "is_deceased": "true"
        },
        "allColumns": {
          "id": {
            "path": "id",
            "name": "id",
            "type": "id",
            "collection": false,
            "inferredCollection": false
          }
        }
      },
      "expect": [
        {
          "id": "pt2"
        }
      ],
      "result": {
        "passed": true
      }
    },
    {
      "title": "accessing an undefined constant",
      "view": {
        "resource": "Patient",
        "select": [
          {
            "column": [
              {
                "path": "family",
                "name": "official_name",
                "type": "string",
                "collection": false,
                "inferredCollection": false
              }
            ],
            "forEach": "name.where(use = %wrong_name)"
          }
        ],
        "constant": [
          {
            "name": "name_use",
            "valueString": "official"
          }
        ],
        "constMap": {
          "name_use": "'official'"
        }
      },
      "expectError": true
    },
    {
      "title": "incorrect constant definition",
      "view": {
        "resource": "Patient",
        "select": [
          {
            "column": [
              {
                "path": "id",
                "name": "id",
                "type": "id",
                "collection": false,
                "inferredCollection": false
              },
              {
                "path": "name.where(use = %name_use).family",
                "name": "official_name",
                "type": "string",
                "collection": false,
                "inferredCollection": false
              }
            ]
          }
        ],
        "constant": [
          {
            "name": "name_use"
          }
        ],
        "constMap": {}
      },
      "expectError": true
    }
  ]
},
{
  "title": "fn_empty",
  "resources": [
    {
      "resourceType": "Patient",
      "id": "p1",
      "name": [
        {
          "use": "official",
          "family": "f1"
        }
      ]
    },
    {
      "resourceType": "Patient",
      "id": "p2"
    }
  ],
  "tests": [
    {
      "title": "empty names",
      "view": {
        "resource": "Patient",
        "select": [
          {
            "column": [
              {
                "path": "id",
                "name": "id",
                "type": "id",
                "collection": false,
                "inferredCollection": false
              },
              {
                "path": "name.empty()",
                "name": "name_empty",
                "type": "boolean",
                "collection": false,
                "inferredCollection": false
              }
            ]
          }
        ],
        "constMap": {},
        "allColumns": {
          "id": {
            "path": "id",
            "name": "id",
            "type": "id",
            "collection": false,
            "inferredCollection": false
          },
          "name_empty": {
            "path": "name.empty()",
            "name": "name_empty",
            "type": "boolean",
            "collection": false,
            "inferredCollection": false
          }
        }
      },
      "expect": [
        {
          "id": "p1",
          "name_empty": false
        },
        {
          "id": "p2",
          "name_empty": true
        }
      ],
      "result": {
        "passed": true
      }
    }
  ]
},
{
  "title": "union",
  "resources": [
    {
      "resourceType": "Patient",
      "id": "pt1",
      "telecom": [
        {
          "value": "t1.1",
          "system": "phone"
        },
        {
          "value": "t1.2",
          "system": "fax"
        },
        {
          "value": "t1.3",
          "system": "email"
        }
      ],
      "contact": [
        {
          "telecom": [
            {
              "value": "t1.c1.1",
              "system": "pager"
            }
          ]
        },
        {
          "telecom": [
            {
              "value": "t1.c2.1",
              "system": "url"
            },
            {
              "value": "t1.c2.2",
              "system": "sms"
            }
          ]
        }
      ]
    },
    {
      "resourceType": "Patient",
      "id": "pt2",
      "telecom": [
        {
          "value": "t2.1",
          "system": "phone"
        },
        {
          "value": "t2.2",
          "system": "fax"
        }
      ]
    },
    {
      "resourceType": "Patient",
      "id": "pt3",
      "contact": [
        {
          "telecom": [
            {
              "value": "t3.c1.1",
              "system": "email"
            },
            {
              "value": "t3.c1.2",
              "system": "pager"
            }
          ]
        },
        {
          "telecom": [
            {
              "value": "t3.c2.1",
              "system": "sms"
            }
          ]
        }
      ]
    },
    {
      "resourceType": "Patient",
      "id": "pt4"
    }
  ],
  "tests": [
    {
      "title": "basic",
      "view": {
        "resource": "Patient",
        "select": [
          {
            "column": [
              {
                "path": "id",
                "name": "id",
                "type": "id",
                "collection": false,
                "inferredCollection": false
              }
            ]
          },
          {
            "unionAll": [
              {
                "column": [
                  {
                    "path": "value",
                    "name": "tel",
                    "type": "string",
                    "collection": false,
                    "inferredCollection": false
                  },
                  {
                    "path": "system",
                    "name": "sys",
                    "type": "code",
                    "collection": false,
                    "inferredCollection": false
                  }
                ],
                "forEach": "telecom"
              },
              {
                "column": [
                  {
                    "path": "value",
                    "name": "tel",
                    "type": "string",
                    "collection": false,
                    "inferredCollection": false
                  },
                  {
                    "path": "system",
                    "name": "sys",
                    "type": "code",
                    "collection": false,
                    "inferredCollection": false
                  }
                ],
                "forEach": "contact.telecom"
              }
            ]
          }
        ],
        "constMap": {},
        "allColumns": {
          "id": {
            "path": "id",
            "name": "id",
            "type": "id",
            "collection": false,
            "inferredCollection": false
          },
          "tel": {
            "path": "value",
            "name": "tel",
            "type": "string",
            "collection": false,
            "inferredCollection": false
          },
          "sys": {
            "path": "system",
            "name": "sys",
            "type": "code",
            "collection": false,
            "inferredCollection": false
          }
        }
      },
      "expect": [
        {
          "tel": "t1.1",
          "sys": "phone",
          "id": "pt1"
        },
        {
          "tel": "t1.2",
          "sys": "fax",
          "id": "pt1"
        },
        {
          "tel": "t1.3",
          "sys": "email",
          "id": "pt1"
        },
        {
          "tel": "t1.c1.1",
          "sys": "pager",
          "id": "pt1"
        },
        {
          "tel": "t1.c2.1",
          "sys": "url",
          "id": "pt1"
        },
        {
          "tel": "t1.c2.2",
          "sys": "sms",
          "id": "pt1"
        },
        {
          "tel": "t2.1",
          "sys": "phone",
          "id": "pt2"
        },
        {
          "tel": "t2.2",
          "sys": "fax",
          "id": "pt2"
        },
        {
          "tel": "t3.c1.1",
          "sys": "email",
          "id": "pt3"
        },
        {
          "tel": "t3.c1.2",
          "sys": "pager",
          "id": "pt3"
        },
        {
          "tel": "t3.c2.1",
          "sys": "sms",
          "id": "pt3"
        }
      ],
      "result": {
        "passed": true
      }
    },
    {
      "title": "unionAll + column",
      "view": {
        "resource": "Patient",
        "select": [
          {
            "column": [
              {
                "path": "id",
                "name": "id",
                "type": "id",
                "collection": false,
                "inferredCollection": false
              }
            ],
            "unionAll": [
              {
                "column": [
                  {
                    "path": "value",
                    "name": "tel",
                    "type": "string",
                    "collection": false,
                    "inferredCollection": false
                  },
                  {
                    "path": "system",
                    "name": "sys",
                    "type": "code",
                    "collection": false,
                    "inferredCollection": false
                  }
                ],
                "forEach": "telecom"
              },
              {
                "column": [
                  {
                    "path": "value",
                    "name": "tel",
                    "type": "string",
                    "collection": false,
                    "inferredCollection": false
                  },
                  {
                    "path": "system",
                    "name": "sys",
                    "type": "code",
                    "collection": false,
                    "inferredCollection": false
                  }
                ],
                "forEach": "contact.telecom"
              }
            ]
          }
        ],
        "constMap": {},
        "allColumns": {
          "id": {
            "path": "id",
            "name": "id",
            "type": "id",
            "collection": false,
            "inferredCollection": false
          },
          "tel": {
            "path": "value",
            "name": "tel",
            "type": "string",
            "collection": false,
            "inferredCollection": false
          },
          "sys": {
            "path": "system",
            "name": "sys",
            "type": "code",
            "collection": false,
            "inferredCollection": false
          }
        }
      },
      "expect": [
        {
          "tel": "t1.1",
          "sys": "phone",
          "id": "pt1"
        },
        {
          "tel": "t1.2",
          "sys": "fax",
          "id": "pt1"
        },
        {
          "tel": "t1.3",
          "sys": "email",
          "id": "pt1"
        },
        {
          "tel": "t1.c1.1",
          "sys": "pager",
          "id": "pt1"
        },
        {
          "tel": "t1.c2.1",
          "sys": "url",
          "id": "pt1"
        },
        {
          "tel": "t1.c2.2",
          "sys": "sms",
          "id": "pt1"
        },
        {
          "tel": "t2.1",
          "sys": "phone",
          "id": "pt2"
        },
        {
          "tel": "t2.2",
          "sys": "fax",
          "id": "pt2"
        },
        {
          "tel": "t3.c1.1",
          "sys": "email",
          "id": "pt3"
        },
        {
          "tel": "t3.c1.2",
          "sys": "pager",
          "id": "pt3"
        },
        {
          "tel": "t3.c2.1",
          "sys": "sms",
          "id": "pt3"
        }
      ],
      "result": {
        "passed": true
      }
    },
    {
      "title": "duplicates",
      "view": {
        "resource": "Patient",
        "select": [
          {
            "column": [
              {
                "path": "id",
                "name": "id",
                "type": "id",
                "collection": false,
                "inferredCollection": false
              }
            ],
            "unionAll": [
              {
                "column": [
                  {
                    "path": "value",
                    "name": "tel",
                    "type": "string",
                    "collection": false,
                    "inferredCollection": false
                  },
                  {
                    "path": "system",
                    "name": "sys",
                    "type": "code",
                    "collection": false,
                    "inferredCollection": false
                  }
                ],
                "forEach": "telecom"
              },
              {
                "column": [
                  {
                    "path": "value",
                    "name": "tel",
                    "type": "string",
                    "collection": false,
                    "inferredCollection": false
                  },
                  {
                    "path": "system",
                    "name": "sys",
                    "type": "code",
                    "collection": false,
                    "inferredCollection": false
                  }
                ],
                "forEach": "telecom"
              }
            ]
          }
        ],
        "constMap": {},
        "allColumns": {
          "id": {
            "path": "id",
            "name": "id",
            "type": "id",
            "collection": false,
            "inferredCollection": false
          },
          "tel": {
            "path": "value",
            "name": "tel",
            "type": "string",
            "collection": false,
            "inferredCollection": false
          },
          "sys": {
            "path": "system",
            "name": "sys",
            "type": "code",
            "collection": false,
            "inferredCollection": false
          }
        }
      },
      "expect": [
        {
          "tel": "t1.1",
          "sys": "phone",
          "id": "pt1"
        },
        {
          "tel": "t1.2",
          "sys": "fax",
          "id": "pt1"
        },
        {
          "tel": "t1.3",
          "sys": "email",
          "id": "pt1"
        },
        {
          "tel": "t1.1",
          "sys": "phone",
          "id": "pt1"
        },
        {
          "tel": "t1.2",
          "sys": "fax",
          "id": "pt1"
        },
        {
          "tel": "t1.3",
          "sys": "email",
          "id": "pt1"
        },
        {
          "tel": "t2.1",
          "sys": "phone",
          "id": "pt2"
        },
        {
          "tel": "t2.2",
          "sys": "fax",
          "id": "pt2"
        },
        {
          "tel": "t2.1",
          "sys": "phone",
          "id": "pt2"
        },
        {
          "tel": "t2.2",
          "sys": "fax",
          "id": "pt2"
        }
      ],
      "result": {
        "passed": true
      }
    },
    {
      "title": "empty results",
      "view": {
        "resource": "Patient",
        "select": [
          {
            "column": [
              {
                "path": "id",
                "name": "id",
                "type": "id",
                "collection": false,
                "inferredCollection": false
              }
            ],
            "unionAll": [
              {
                "column": [
                  {
                    "path": "given",
                    "name": "given",
                    "type": "string",
                    "collection": false,
                    "inferredCollection": false
                  }
                ],
                "forEach": "name"
              },
              {
                "column": [
                  {
                    "path": "given",
                    "name": "given",
                    "type": "string",
                    "collection": false,
                    "inferredCollection": false
                  }
                ],
                "forEach": "name"
              }
            ]
          }
        ],
        "constMap": {},
        "allColumns": {
          "id": {
            "path": "id",
            "name": "id",
            "type": "id",
            "collection": false,
            "inferredCollection": false
          },
          "given": {
            "path": "given",
            "name": "given",
            "type": "string",
            "collection": false,
            "inferredCollection": false
          }
        }
      },
      "expect": [],
      "result": {
        "passed": true
      }
    },
    {
      "title": "empty with forEachOrNull",
      "view": {
        "resource": "Patient",
        "select": [
          {
            "column": [
              {
                "path": "id",
                "name": "id",
                "type": "id",
                "collection": false,
                "inferredCollection": false
              }
            ],
            "unionAll": [
              {
                "column": [
                  {
                    "path": "given",
                    "name": "given",
                    "type": "string",
                    "collection": false,
                    "inferredCollection": false
                  }
                ],
                "forEachOrNull": "name"
              },
              {
                "column": [
                  {
                    "path": "given",
                    "name": "given",
                    "type": "string",
                    "collection": false,
                    "inferredCollection": false
                  }
                ],
                "forEachOrNull": "name"
              }
            ]
          }
        ],
        "constMap": {},
        "allColumns": {
          "id": {
            "path": "id",
            "name": "id",
            "type": "id",
            "collection": false,
            "inferredCollection": false
          },
          "given": {
            "path": "given",
            "name": "given",
            "type": "string",
            "collection": false,
            "inferredCollection": false
          }
        }
      },
      "expect": [
        {
          "id": "pt1"
        },
        {
          "id": "pt1"
        },
        {
          "id": "pt2"
        },
        {
          "id": "pt2"
        },
        {
          "id": "pt3"
        },
        {
          "id": "pt3"
        },
        {
          "id": "pt4"
        },
        {
          "id": "pt4"
        }
      ],
      "result": {
        "passed": true
      }
    },
    {
      "title": "forEachOrNull and forEach",
      "view": {
        "resource": "Patient",
        "select": [
          {
            "column": [
              {
                "path": "id",
                "name": "id",
                "type": "id",
                "collection": false,
                "inferredCollection": false
              }
            ],
            "unionAll": [
              {
                "column": [
                  {
                    "path": "given",
                    "name": "given",
                    "type": "string",
                    "collection": false,
                    "inferredCollection": false
                  }
                ],
                "forEach": "name"
              },
              {
                "column": [
                  {
                    "path": "given",
                    "name": "given",
                    "type": "string",
                    "collection": false,
                    "inferredCollection": false
                  }
                ],
                "forEachOrNull": "name"
              }
            ]
          }
        ],
        "constMap": {},
        "allColumns": {
          "id": {
            "path": "id",
            "name": "id",
            "type": "id",
            "collection": false,
            "inferredCollection": false
          },
          "given": {
            "path": "given",
            "name": "given",
            "type": "string",
            "collection": false,
            "inferredCollection": false
          }
        }
      },
      "expect": [
        {
          "id": "pt1"
        },
        {
          "id": "pt2"
        },
        {
          "id": "pt3"
        },
        {
          "id": "pt4"
        }
      ],
      "result": {
        "passed": true
      }
    },
    {
      "title": "nested",
      "view": {
        "resource": "Patient",
        "select": [
          {
            "column": [
              {
                "path": "id",
                "name": "id",
                "type": "id",
                "collection": false,
                "inferredCollection": false
              }
            ],
            "unionAll": [
              {
                "column": [
                  {
                    "path": "value",
                    "name": "tel",
                    "type": "string",
                    "collection": false,
                    "inferredCollection": false
                  }
                ],
                "forEach": "telecom[0]"
              },
              {
                "unionAll": [
                  {
                    "column": [
                      {
                        "path": "value",
                        "name": "tel",
                        "type": "string",
                        "collection": false,
                        "inferredCollection": false
                      }
                    ],
                    "forEach": "telecom[0]"
                  },
                  {
                    "column": [
                      {
                        "path": "value",
                        "name": "tel",
                        "type": "string",
                        "collection": false,
                        "inferredCollection": false
                      }
                    ],
                    "forEach": "contact.telecom[0]"
                  }
                ]
              }
            ]
          }
        ],
        "constMap": {},
        "allColumns": {
          "id": {
            "path": "id",
            "name": "id",
            "type": "id",
            "collection": false,
            "inferredCollection": false
          },
          "tel": {
            "path": "value",
            "name": "tel",
            "type": "string",
            "collection": false,
            "inferredCollection": false
          }
        }
      },
      "expect": [
        {
          "id": "pt1",
          "tel": "t1.1"
        },
        {
          "id": "pt1",
          "tel": "t1.1"
        },
        {
          "id": "pt1",
          "tel": "t1.c1.1"
        },
        {
          "id": "pt2",
          "tel": "t2.1"
        },
        {
          "id": "pt2",
          "tel": "t2.1"
        },
        {
          "id": "pt3",
          "tel": "t3.c1.1"
        }
      ],
      "result": {
        "passed": true
      }
    },
    {
      "title": "one empty operand",
      "view": {
        "resource": "Patient",
        "select": [
          {
            "column": [
              {
                "path": "id",
                "name": "id",
                "type": "id",
                "collection": false,
                "inferredCollection": false
              }
            ]
          },
          {
            "unionAll": [
              {
                "column": [
                  {
                    "path": "value",
                    "name": "tel",
                    "type": "string",
                    "collection": false,
                    "inferredCollection": false
                  },
                  {
                    "path": "system",
                    "name": "sys",
                    "type": "code",
                    "collection": false,
                    "inferredCollection": false
                  }
                ],
                "forEach": "telecom.where(false)"
              },
              {
                "column": [
                  {
                    "path": "value",
                    "name": "tel",
                    "type": "string",
                    "collection": false,
                    "inferredCollection": false
                  },
                  {
                    "path": "system",
                    "name": "sys",
                    "type": "code",
                    "collection": false,
                    "inferredCollection": false
                  }
                ],
                "forEach": "contact.telecom"
              }
            ]
          }
        ],
        "constMap": {},
        "allColumns": {
          "id": {
            "path": "id",
            "name": "id",
            "type": "id",
            "collection": false,
            "inferredCollection": false
          },
          "tel": {
            "path": "value",
            "name": "tel",
            "type": "string",
            "collection": false,
            "inferredCollection": false
          },
          "sys": {
            "path": "system",
            "name": "sys",
            "type": "code",
            "collection": false,
            "inferredCollection": false
          }
        }
      },
      "expect": [
        {
          "id": "pt1",
          "sys": "pager",
          "tel": "t1.c1.1"
        },
        {
          "id": "pt1",
          "sys": "url",
          "tel": "t1.c2.1"
        },
        {
          "id": "pt1",
          "sys": "sms",
          "tel": "t1.c2.2"
        },
        {
          "id": "pt3",
          "sys": "email",
          "tel": "t3.c1.1"
        },
        {
          "id": "pt3",
          "sys": "pager",
          "tel": "t3.c1.2"
        },
        {
          "id": "pt3",
          "sys": "sms",
          "tel": "t3.c2.1"
        }
      ],
      "result": {
        "passed": true
      }
    },
    {
      "title": "column mismatch",
      "view": {
        "resource": "Patient",
        "select": [
          {
            "unionAll": [
              {
                "column": [
                  {
                    "path": "id",
                    "name": "a",
                    "type": "id",
                    "collection": false,
                    "inferredCollection": false
                  },
                  {
                    "path": "id",
                    "name": "b",
                    "type": "id",
                    "collection": false,
                    "inferredCollection": false
                  }
                ]
              },
              {
                "column": [
                  {
                    "path": "id",
                    "name": "a",
                    "type": "id",
                    "collection": false,
                    "inferredCollection": false
                  },
                  {
                    "path": "id",
                    "name": "c",
                    "type": "id",
                    "collection": false,
                    "inferredCollection": false
                  }
                ]
              }
            ]
          }
        ],
        "constMap": {}
      },
      "expectError": true
    },
    {
      "title": "column order mismatch",
      "view": {
        "resource": "Patient",
        "select": [
          {
            "unionAll": [
              {
                "column": [
                  {
                    "path": "id",
                    "name": "a",
                    "type": "id",
                    "collection": false,
                    "inferredCollection": false
                  },
                  {
                    "path": "id",
                    "name": "b",
                    "type": "id",
                    "collection": false,
                    "inferredCollection": false
                  }
                ]
              },
              {
                "column": [
                  {
                    "path": "id",
                    "name": "b",
                    "type": "id",
                    "collection": false,
                    "inferredCollection": false
                  },
                  {
                    "path": "id",
                    "name": "a",
                    "type": "id",
                    "collection": false,
                    "inferredCollection": false
                  }
                ]
              }
            ]
          }
        ],
        "constMap": {}
      },
      "expectError": true
    }
  ]
},
{
  "title": "fhirpath_numbers",
  "resources": [
    {
      "resourceType": "Observation",
      "id": "o1",
      "code": {
        "text": "code"
      },
      "status": "final",
      "valueRange": {
        "low": {
          "value": 2
        },
        "high": {
          "value": 3
        }
      }
    }
  ],
  "tests": [
    {
      "title": "add observation",
      "view": {
        "resource": "Observation",
        "select": [
          {
            "column": [
              {
                "path": "id",
                "name": "id",
                "type": "id",
                "collection": false,
                "inferredCollection": false
              },
              {
                "path": "value.ofType(Range).low.value + value.ofType(Range).high.value",
                "name": "add",
                "type": "integer",
                "collection": false,
                "inferredCollection": false
              },
              {
                "path": "value.ofType(Range).high.value - value.ofType(Range).low.value",
                "name": "sub",
                "type": "integer",
                "collection": false,
                "inferredCollection": false
              },
              {
                "path": "value.ofType(Range).low.value * value.ofType(Range).high.value",
                "name": "mul",
                "type": "integer",
                "collection": false,
                "inferredCollection": false
              },
              {
                "path": "value.ofType(Range).high.value / value.ofType(Range).low.value",
                "name": "div",
                "type": "decimal",
                "collection": false,
                "inferredCollection": false
              },
              {
                "path": "value.ofType(Range).high.value = value.ofType(Range).low.value",
                "name": "eq",
                "type": "boolean",
                "collection": false,
                "inferredCollection": false
              },
              {
                "path": "value.ofType(Range).high.value > value.ofType(Range).low.value",
                "name": "gt",
                "type": "boolean",
                "collection": false,
                "inferredCollection": false
              },
              {
                "path": "value.ofType(Range).high.value >= value.ofType(Range).low.value",
                "name": "ge",
                "type": "boolean",
                "collection": false,
                "inferredCollection": false
              },
              {
                "path": "value.ofType(Range).high.value < value.ofType(Range).low.value",
                "name": "lt",
                "type": "boolean",
                "collection": false,
                "inferredCollection": false
              },
              {
                "path": "value.ofType(Range).high.value <= value.ofType(Range).low.value",
                "name": "le",
                "type": "boolean",
                "collection": false,
                "inferredCollection": false
              }
            ]
          }
        ],
        "constMap": {},
        "allColumns": {
          "id": {
            "path": "id",
            "name": "id",
            "type": "id",
            "collection": false,
            "inferredCollection": false
          },
          "add": {
            "path": "value.ofType(Range).low.value + value.ofType(Range).high.value",
            "name": "add",
            "type": "integer",
            "collection": false,
            "inferredCollection": false
          },
          "sub": {
            "path": "value.ofType(Range).high.value - value.ofType(Range).low.value",
            "name": "sub",
            "type": "integer",
            "collection": false,
            "inferredCollection": false
          },
          "mul": {
            "path": "value.ofType(Range).low.value * value.ofType(Range).high.value",
            "name": "mul",
            "type": "integer",
            "collection": false,
            "inferredCollection": false
          },
          "div": {
            "path": "value.ofType(Range).high.value / value.ofType(Range).low.value",
            "name": "div",
            "type": "decimal",
            "collection": false,
            "inferredCollection": false
          },
          "eq": {
            "path": "value.ofType(Range).high.value = value.ofType(Range).low.value",
            "name": "eq",
            "type": "boolean",
            "collection": false,
            "inferredCollection": false
          },
          "gt": {
            "path": "value.ofType(Range).high.value > value.ofType(Range).low.value",
            "name": "gt",
            "type": "boolean",
            "collection": false,
            "inferredCollection": false
          },
          "ge": {
            "path": "value.ofType(Range).high.value >= value.ofType(Range).low.value",
            "name": "ge",
            "type": "boolean",
            "collection": false,
            "inferredCollection": false
          },
          "lt": {
            "path": "value.ofType(Range).high.value < value.ofType(Range).low.value",
            "name": "lt",
            "type": "boolean",
            "collection": false,
            "inferredCollection": false
          },
          "le": {
            "path": "value.ofType(Range).high.value <= value.ofType(Range).low.value",
            "name": "le",
            "type": "boolean",
            "collection": false,
            "inferredCollection": false
          }
        }
      },
      "expect": [
        {
          "id": "o1",
          "add": 5,
          "sub": 1,
          "mul": 6,
          "div": 1.5,
          "eq": false,
          "gt": true,
          "ge": true,
          "lt": false,
          "le": false
        }
      ],
      "result": {
        "passed": true
      }
    }
  ]
},
{
  "title": "combinations",
  "resources": [
    {
      "id": "pt1",
      "resourceType": "Patient"
    },
    {
      "id": "pt2",
      "resourceType": "Patient"
    },
    {
      "id": "pt3",
      "resourceType": "Patient"
    }
  ],
  "tests": [
    {
      "title": "select",
      "view": {
        "resource": "Patient",
        "select": [
          {
            "select": [
              {
                "column": [
                  {
                    "path": "id",
                    "name": "id",
                    "type": "id",
                    "collection": false,
                    "inferredCollection": false
                  }
                ]
              }
            ]
          }
        ],
        "constMap": {},
        "allColumns": {
          "id": {
            "path": "id",
            "name": "id",
            "type": "id",
            "collection": false,
            "inferredCollection": false
          }
        }
      },
      "expect": [
        {
          "id": "pt1"
        },
        {
          "id": "pt2"
        },
        {
          "id": "pt3"
        }
      ],
      "result": {
        "passed": true
      }
    },
    {
      "title": "column + select",
      "view": {
        "resource": "Patient",
        "select": [
          {
            "column": [
              {
                "path": "id",
                "name": "column_id",
                "type": "id",
                "collection": false,
                "inferredCollection": false
              }
            ],
            "select": [
              {
                "column": [
                  {
                    "path": "id",
                    "name": "select_id",
                    "type": "id",
                    "collection": false,
                    "inferredCollection": false
                  }
                ]
              }
            ]
          }
        ],
        "constMap": {},
        "allColumns": {
          "column_id": {
            "path": "id",
            "name": "column_id",
            "type": "id",
            "collection": false,
            "inferredCollection": false
          },
          "select_id": {
            "path": "id",
            "name": "select_id",
            "type": "id",
            "collection": false,
            "inferredCollection": false
          }
        }
      },
      "expect": [
        {
          "column_id": "pt1",
          "select_id": "pt1"
        },
        {
          "column_id": "pt2",
          "select_id": "pt2"
        },
        {
          "column_id": "pt3",
          "select_id": "pt3"
        }
      ],
      "result": {
        "passed": true
      }
    },
    {
      "title": "sibling select",
      "view": {
        "resource": "Patient",
        "select": [
          {
            "column": [
              {
                "path": "id",
                "name": "id_1",
                "type": "id",
                "collection": false,
                "inferredCollection": false
              }
            ]
          },
          {
            "column": [
              {
                "path": "id",
                "name": "id_2",
                "type": "id",
                "collection": false,
                "inferredCollection": false
              }
            ]
          }
        ],
        "constMap": {},
        "allColumns": {
          "id_1": {
            "path": "id",
            "name": "id_1",
            "type": "id",
            "collection": false,
            "inferredCollection": false
          },
          "id_2": {
            "path": "id",
            "name": "id_2",
            "type": "id",
            "collection": false,
            "inferredCollection": false
          }
        }
      },
      "expect": [
        {
          "id_1": "pt1",
          "id_2": "pt1"
        },
        {
          "id_1": "pt2",
          "id_2": "pt2"
        },
        {
          "id_1": "pt3",
          "id_2": "pt3"
        }
      ],
      "result": {
        "passed": true
      }
    },
    {
      "title": "sibling select inside a select",
      "view": {
        "resource": "Patient",
        "select": [
          {
            "select": [
              {
                "column": [
                  {
                    "path": "id",
                    "name": "id_1",
                    "type": "id",
                    "collection": false,
                    "inferredCollection": false
                  }
                ]
              },
              {
                "column": [
                  {
                    "path": "id",
                    "name": "id_2",
                    "type": "id",
                    "collection": false,
                    "inferredCollection": false
                  }
                ]
              }
            ]
          }
        ],
        "constMap": {},
        "allColumns": {
          "id_1": {
            "path": "id",
            "name": "id_1",
            "type": "id",
            "collection": false,
            "inferredCollection": false
          },
          "id_2": {
            "path": "id",
            "name": "id_2",
            "type": "id",
            "collection": false,
            "inferredCollection": false
          }
        }
      },
      "expect": [
        {
          "id_1": "pt1",
          "id_2": "pt1"
        },
        {
          "id_1": "pt2",
          "id_2": "pt2"
        },
        {
          "id_1": "pt3",
          "id_2": "pt3"
        }
      ],
      "result": {
        "passed": true
      }
    },
    {
      "title": "column + select, with where",
      "view": {
        "resource": "Patient",
        "select": [
          {
            "column": [
              {
                "path": "id",
                "name": "column_id",
                "type": "id",
                "collection": false,
                "inferredCollection": false
              }
            ],
            "select": [
              {
                "column": [
                  {
                    "path": "id",
                    "name": "select_id",
                    "type": "id",
                    "collection": false,
                    "inferredCollection": false
                  }
                ]
              }
            ]
          }
        ],
        "where": [
          {
            "path": "id = 'pt1'"
          }
        ],
        "constMap": {},
        "allColumns": {
          "column_id": {
            "path": "id",
            "name": "column_id",
            "type": "id",
            "collection": false,
            "inferredCollection": false
          },
          "select_id": {
            "path": "id",
            "name": "select_id",
            "type": "id",
            "collection": false,
            "inferredCollection": false
          }
        }
      },
      "expect": [
        {
          "column_id": "pt1",
          "select_id": "pt1"
        }
      ],
      "result": {
        "passed": true
      }
    },
    {
      "title": "unionAll + forEach + column + select",
      "view": {
        "resource": "Patient",
        "select": [
          {
            "select": [
              {
                "column": [
                  {
                    "path": "id",
                    "name": "id",
                    "type": "id",
                    "collection": false,
                    "inferredCollection": false
                  }
                ]
              }
            ]
          }
        ],
        "constMap": {},
        "allColumns": {
          "id": {
            "path": "id",
            "name": "id",
            "type": "id",
            "collection": false,
            "inferredCollection": false
          }
        }
      },
      "expect": [
        {
          "id": "pt1"
        },
        {
          "id": "pt2"
        },
        {
          "id": "pt3"
        }
      ],
      "result": {
        "passed": true
      }
    }
  ]
},
{
  "title": "validate",
  "resources": [
    {
      "resourceType": "Patient",
      "name": [
        {
          "family": "F1.1"
        }
      ],
      "id": "pt1"
    },
    {
      "resourceType": "Patient",
      "id": "pt2"
    }
  ],
  "tests": [
    {
      "title": "empty",
      "view": {
        "constMap": {}
      },
      "expectError": true
    },
    {
      "title": "missing resource",
      "view": {
        "select": [
          {
            "column": [
              {
                "path": "id",
                "name": "id",
                "type": "id",
                "collection": false,
                "inferredCollection": false
              }
            ]
          }
        ],
        "constMap": {}
      },
      "expectError": true
    },
    {
      "title": "wrong fhirpath",
      "view": {
        "resource": "Patient",
        "select": [
          {
            "forEach": "@@"
          }
        ],
        "constMap": {},
        "allColumns": {}
      },
      "expectError": true
    },
    {
      "title": "wrong type in forEach",
      "view": {
        "resource": "Patient",
        "select": [
          {
            "forEach": "1"
          }
        ],
        "constMap": {}
      },
      "expectError": true,
      "result": {
        "passed": false,
        "failureReason": "skipped"
      }
    },
    {
      "title": "where with path resolving to not boolean",
      "view": {
        "resource": "Patient",
        "select": [
          {
            "column": [
              {
                "path": "id",
                "name": "id",
                "type": "id",
                "collection": false,
                "inferredCollection": false
              }
            ]
          }
        ],
        "where": [
          {
            "path": "name.family"
          }
        ],
        "constMap": {},
        "allColumns": {
          "id": {
            "path": "id",
            "name": "id",
            "type": "id",
            "collection": false,
            "inferredCollection": false
          }
        }
      },
      "expectError": true
    }
  ]
},
{
  "title": "where",
  "resources": [
    {
      "resourceType": "Patient",
      "id": "p1",
      "name": [
        {
          "use": "official",
          "family": "f1"
        }
      ]
    },
    {
      "resourceType": "Patient",
      "id": "p2",
      "name": [
        {
          "use": "nickname",
          "family": "f2"
        }
      ]
    },
    {
      "resourceType": "Patient",
      "id": "p3",
      "name": [
        {
          "use": "nickname",
          "given": [
            "g3"
          ],
          "family": "f3"
        }
      ]
    },
    {
      "resourceType": "Observation",
      "id": "o1",
      "valueInteger": 12
    },
    {
      "resourceType": "Observation",
      "id": "o2",
      "valueInteger": 10
    }
  ],
  "tests": [
    {
      "title": "simple where path with result",
      "view": {
        "resource": "Patient",
        "select": [
          {
            "column": [
              {
                "path": "id",
                "name": "id",
                "type": "id",
                "collection": false,
                "inferredCollection": false
              }
            ]
          }
        ],
        "where": [
          {
            "path": "name.where(use = 'official').exists()"
          }
        ],
        "constMap": {},
        "allColumns": {
          "id": {
            "path": "id",
            "name": "id",
            "type": "id",
            "collection": false,
            "inferredCollection": false
          }
        }
      },
      "expect": [
        {
          "id": "p1"
        }
      ],
      "result": {
        "passed": true
      }
    },
    {
      "title": "where path with no results",
      "view": {
        "resource": "Patient",
        "select": [
          {
            "column": [
              {
                "path": "id",
                "name": "id",
                "type": "id",
                "collection": false,
                "inferredCollection": false
              }
            ]
          }
        ],
        "where": [
          {
            "path": "name.where(use = 'maiden').exists()"
          }
        ],
        "constMap": {},
        "allColumns": {
          "id": {
            "path": "id",
            "name": "id",
            "type": "id",
            "collection": false,
            "inferredCollection": false
          }
        }
      },
      "expect": [],
      "result": {
        "passed": true
      }
    },
    {
      "title": "where path with greater than inequality",
      "view": {
        "resource": "Observation",
        "select": [
          {
            "column": [
              {
                "path": "id",
                "name": "id",
                "type": "id",
                "collection": false,
                "inferredCollection": false
              }
            ]
          }
        ],
        "where": [
          {
            "path": "where(value.ofType(integer) > 11).exists()"
          }
        ],
        "constMap": {},
        "allColumns": {
          "id": {
            "path": "id",
            "name": "id",
            "type": "id",
            "collection": false,
            "inferredCollection": false
          }
        }
      },
      "expect": [
        {
          "id": "o1"
        }
      ],
      "result": {
        "passed": true
      }
    },
    {
      "title": "where path with less than inequality",
      "view": {
        "resource": "Observation",
        "select": [
          {
            "column": [
              {
                "path": "id",
                "name": "id",
                "type": "id",
                "collection": false,
                "inferredCollection": false
              }
            ]
          }
        ],
        "where": [
          {
            "path": "where(value.ofType(integer) < 11).exists()"
          }
        ],
        "constMap": {},
        "allColumns": {
          "id": {
            "path": "id",
            "name": "id",
            "type": "id",
            "collection": false,
            "inferredCollection": false
          }
        }
      },
      "expect": [
        {
          "id": "o2"
        }
      ],
      "result": {
        "passed": true
      }
    },
    {
      "title": "multiple where paths",
      "view": {
        "resource": "Patient",
        "select": [
          {
            "column": [
              {
                "path": "id",
                "name": "id",
                "type": "id",
                "collection": false,
                "inferredCollection": false
              }
            ]
          }
        ],
        "where": [
          {
            "path": "name.where(use = 'official').exists()"
          },
          {
            "path": "name.where(family = 'f1').exists()"
          }
        ],
        "constMap": {},
        "allColumns": {
          "id": {
            "path": "id",
            "name": "id",
            "type": "id",
            "collection": false,
            "inferredCollection": false
          }
        }
      },
      "expect": [
        {
          "id": "p1"
        }
      ],
      "result": {
        "passed": true
      }
    },
    {
      "title": "where path with an 'and' connector",
      "view": {
        "resource": "Patient",
        "select": [
          {
            "column": [
              {
                "path": "id",
                "name": "id",
                "type": "id",
                "collection": false,
                "inferredCollection": false
              }
            ]
          }
        ],
        "where": [
          {
            "path": "name.where(use = 'official' and family = 'f1').exists()"
          }
        ],
        "constMap": {},
        "allColumns": {
          "id": {
            "path": "id",
            "name": "id",
            "type": "id",
            "collection": false,
            "inferredCollection": false
          }
        }
      },
      "expect": [
        {
          "id": "p1"
        }
      ],
      "result": {
        "passed": true
      }
    },
    {
      "title": "where path with an 'or' connector",
      "view": {
        "resource": "Patient",
        "select": [
          {
            "column": [
              {
                "path": "id",
                "name": "id",
                "type": "id",
                "collection": false,
                "inferredCollection": false
              }
            ]
          }
        ],
        "where": [
          {
            "path": "name.where(use = 'official' or family = 'f2').exists()"
          }
        ],
        "constMap": {},
        "allColumns": {
          "id": {
            "path": "id",
            "name": "id",
            "type": "id",
            "collection": false,
            "inferredCollection": false
          }
        }
      },
      "expect": [
        {
          "id": "p1"
        },
        {
          "id": "p2"
        }
      ],
      "result": {
        "passed": true
      }
    },
    {
      "title": "where path that evaluates to true when empty",
      "view": {
        "resource": "Patient",
        "select": [
          {
            "column": [
              {
                "path": "id",
                "name": "id",
                "type": "id",
                "collection": false,
                "inferredCollection": false
              }
            ]
          }
        ],
        "where": [
          {
            "path": "name.where(family = 'f2').empty()"
          }
        ],
        "constMap": {},
        "allColumns": {
          "id": {
            "path": "id",
            "name": "id",
            "type": "id",
            "collection": false,
            "inferredCollection": false
          }
        }
      },
      "expect": [
        {
          "id": "p1"
        },
        {
          "id": "p3"
        }
      ],
      "result": {
        "passed": true
      }
    }
  ]
},
{
  "title": "basic",
  "resources": [
    {
      "resourceType": "Patient",
      "id": "pt1",
      "name": [
        {
          "family": "F1"
        }
      ],
      "active": true
    },
    {
      "resourceType": "Patient",
      "id": "pt2",
      "name": [
        {
          "family": "F2"
        }
      ],
      "active": false
    },
    {
      "resourceType": "Patient",
      "id": "pt3"
    }
  ],
  "tests": [
    {
      "title": "basic attribute",
      "view": {
        "resource": "Patient",
        "select": [
          {
            "column": [
              {
                "path": "id",
                "name": "id",
                "type": "id",
                "collection": false,
                "inferredCollection": false
              }
            ]
          }
        ],
        "constMap": {},
        "allColumns": {
          "id": {
            "path": "id",
            "name": "id",
            "type": "id",
            "collection": false,
            "inferredCollection": false
          }
        }
      },
      "expect": [
        {
          "id": "pt1"
        },
        {
          "id": "pt2"
        },
        {
          "id": "pt3"
        }
      ],
      "result": {
        "passed": true
      }
    },
    {
      "title": "boolean attribute with false",
      "view": {
        "resource": "Patient",
        "select": [
          {
            "column": [
              {
                "path": "id",
                "name": "id",
                "type": "id",
                "collection": false,
                "inferredCollection": false
              },
              {
                "path": "active",
                "name": "active",
                "type": "boolean",
                "collection": false,
                "inferredCollection": false
              }
            ]
          }
        ],
        "constMap": {},
        "allColumns": {
          "id": {
            "path": "id",
            "name": "id",
            "type": "id",
            "collection": false,
            "inferredCollection": false
          },
          "active": {
            "path": "active",
            "name": "active",
            "type": "boolean",
            "collection": false,
            "inferredCollection": false
          }
        }
      },
      "expect": [
        {
          "id": "pt1",
          "active": true
        },
        {
          "id": "pt2",
          "active": false
        },
        {
          "id": "pt3"
        }
      ],
      "result": {
        "passed": true
      }
    },
    {
      "title": "two columns",
      "view": {
        "resource": "Patient",
        "select": [
          {
            "column": [
              {
                "path": "id",
                "name": "id",
                "type": "id",
                "collection": false,
                "inferredCollection": false
              },
              {
                "path": "name.family.first()",
                "name": "last_name",
                "type": "string",
                "collection": false,
                "inferredCollection": false
              }
            ]
          }
        ],
        "constMap": {},
        "allColumns": {
          "id": {
            "path": "id",
            "name": "id",
            "type": "id",
            "collection": false,
            "inferredCollection": false
          },
          "last_name": {
            "path": "name.family.first()",
            "name": "last_name",
            "type": "string",
            "collection": false,
            "inferredCollection": false
          }
        }
      },
      "expect": [
        {
          "id": "pt1",
          "last_name": "F1"
        },
        {
          "id": "pt2",
          "last_name": "F2"
        },
        {
          "id": "pt3"
        }
      ],
      "result": {
        "passed": true
      }
    },
    {
      "title": "two selects with columns",
      "view": {
        "resource": "Patient",
        "select": [
          {
            "column": [
              {
                "path": "id",
                "name": "id",
                "type": "id",
                "collection": false,
                "inferredCollection": false
              }
            ]
          },
          {
            "column": [
              {
                "path": "name.family.first()",
                "name": "last_name",
                "type": "string",
                "collection": false,
                "inferredCollection": false
              }
            ]
          }
        ],
        "constMap": {},
        "allColumns": {
          "id": {
            "path": "id",
            "name": "id",
            "type": "id",
            "collection": false,
            "inferredCollection": false
          },
          "last_name": {
            "path": "name.family.first()",
            "name": "last_name",
            "type": "string",
            "collection": false,
            "inferredCollection": false
          }
        }
      },
      "expect": [
        {
          "id": "pt1",
          "last_name": "F1"
        },
        {
          "id": "pt2",
          "last_name": "F2"
        },
        {
          "id": "pt3"
        }
      ],
      "result": {
        "passed": true
      }
    },
    {
      "title": "where - 1",
      "view": {
        "resource": "Patient",
        "select": [
          {
            "column": [
              {
                "path": "id",
                "name": "id",
                "type": "id",
                "collection": false,
                "inferredCollection": false
              }
            ]
          }
        ],
        "where": [
          {
            "path": "active.exists() and active = true"
          }
        ],
        "constMap": {},
        "allColumns": {
          "id": {
            "path": "id",
            "name": "id",
            "type": "id",
            "collection": false,
            "inferredCollection": false
          }
        }
      },
      "expect": [
        {
          "id": "pt1"
        }
      ],
      "result": {
        "passed": true
      }
    },
    {
      "title": "where - 2",
      "view": {
        "resource": "Patient",
        "select": [
          {
            "column": [
              {
                "path": "id",
                "name": "id",
                "type": "id",
                "collection": false,
                "inferredCollection": false
              }
            ]
          }
        ],
        "where": [
          {
            "path": "active.exists() and active = false"
          }
        ],
        "constMap": {},
        "allColumns": {
          "id": {
            "path": "id",
            "name": "id",
            "type": "id",
            "collection": false,
            "inferredCollection": false
          }
        }
      },
      "expect": [
        {
          "id": "pt2"
        }
      ],
      "result": {
        "passed": true
      }
    },
    {
      "title": "where returns non-boolean for some cases",
      "view": {
        "resource": "Patient",
        "select": [
          {
            "column": [
              {
                "path": "id",
                "name": "id",
                "type": "id",
                "collection": false,
                "inferredCollection": false
              }
            ]
          }
        ],
        "where": [
          {
            "path": "active"
          }
        ],
        "constMap": {},
        "allColumns": {
          "id": {
            "path": "id",
            "name": "id",
            "type": "id",
            "collection": false,
            "inferredCollection": false
          }
        }
      },
      "expect": [
        {
          "id": "pt1"
        }
      ],
      "result": {
        "passed": true
      }
    },
    {
      "title": "where as expr - 1",
      "view": {
        "resource": "Patient",
        "select": [
          {
            "column": [
              {
                "path": "id",
                "name": "id",
                "type": "id",
                "collection": false,
                "inferredCollection": false
              }
            ]
          }
        ],
        "where": [
          {
            "path": "name.family.exists() and name.family = 'F2'"
          }
        ],
        "constMap": {},
        "allColumns": {
          "id": {
            "path": "id",
            "name": "id",
            "type": "id",
            "collection": false,
            "inferredCollection": false
          }
        }
      },
      "expect": [
        {
          "id": "pt2"
        }
      ],
      "result": {
        "passed": true
      }
    },
    {
      "title": "where as expr - 2",
      "view": {
        "resource": "Patient",
        "select": [
          {
            "column": [
              {
                "path": "id",
                "name": "id",
                "type": "id",
                "collection": false,
                "inferredCollection": false
              }
            ]
          }
        ],
        "where": [
          {
            "path": "name.family.exists() and name.family = 'F1'"
          }
        ],
        "constMap": {},
        "allColumns": {
          "id": {
            "path": "id",
            "name": "id",
            "type": "id",
            "collection": false,
            "inferredCollection": false
          }
        }
      },
      "expect": [
        {
          "id": "pt1"
        }
      ],
      "result": {
        "passed": true
      }
    },
    {
      "title": "select & column",
      "view": {
        "resource": "Patient",
        "select": [
          {
            "column": [
              {
                "path": "id",
                "name": "c_id",
                "type": "id",
                "collection": false,
                "inferredCollection": false
              }
            ],
            "select": [
              {
                "column": [
                  {
                    "path": "id",
                    "name": "s_id",
                    "type": "id",
                    "collection": false,
                    "inferredCollection": false
                  }
                ]
              }
            ]
          }
        ],
        "constMap": {},
        "allColumns": {
          "c_id": {
            "path": "id",
            "name": "c_id",
            "type": "id",
            "collection": false,
            "inferredCollection": false
          },
          "s_id": {
            "path": "id",
            "name": "s_id",
            "type": "id",
            "collection": false,
            "inferredCollection": false
          }
        }
      },
      "expect": [
        {
          "c_id": "pt1",
          "s_id": "pt1"
        },
        {
          "c_id": "pt2",
          "s_id": "pt2"
        },
        {
          "c_id": "pt3",
          "s_id": "pt3"
        }
      ],
      "result": {
        "passed": true
      }
    }
  ]
},
{
  "title": "foreach",
  "resources": [
    {
      "resourceType": "Patient",
      "id": "pt1",
      "name": [
        {
          "family": "F1.1"
        },
        {
          "family": "F1.2"
        }
      ],
      "contact": [
        {
          "telecom": [
            {
              "system": "phone"
            }
          ],
          "name": {
            "family": "FC1.1",
            "given": [
              "N1",
              "N1`"
            ]
          }
        },
        {
          "telecom": [
            {
              "system": "email"
            }
          ],
          "gender": "unknown",
          "name": {
            "family": "FC1.2",
            "given": [
              "N2"
            ]
          }
        }
      ]
    },
    {
      "resourceType": "Patient",
      "id": "pt2",
      "name": [
        {
          "family": "F2.1"
        },
        {
          "family": "F2.2"
        }
      ]
    },
    {
      "resourceType": "Patient",
      "id": "pt3"
    }
  ],
  "tests": [
    {
      "title": "forEach: normal",
      "view": {
        "resource": "Patient",
        "select": [
          {
            "column": [
              {
                "path": "id",
                "name": "id",
                "type": "id",
                "collection": false,
                "inferredCollection": false
              }
            ]
          },
          {
            "column": [
              {
                "path": "family",
                "name": "family",
                "type": "string",
                "collection": false,
                "inferredCollection": false
              }
            ],
            "forEach": "name"
          }
        ],
        "constMap": {},
        "allColumns": {
          "id": {
            "path": "id",
            "name": "id",
            "type": "id",
            "collection": false,
            "inferredCollection": false
          },
          "family": {
            "path": "family",
            "name": "family",
            "type": "string",
            "collection": false,
            "inferredCollection": false
          }
        }
      },
      "expect": [
        {
          "id": "pt1",
          "family": "F1.1"
        },
        {
          "id": "pt1",
          "family": "F1.2"
        },
        {
          "id": "pt2",
          "family": "F2.1"
        },
        {
          "id": "pt2",
          "family": "F2.2"
        }
      ],
      "result": {
        "passed": true
      }
    },
    {
      "title": "forEachOrNull: basic",
      "view": {
        "resource": "Patient",
        "select": [
          {
            "column": [
              {
                "path": "id",
                "name": "id",
                "type": "id",
                "collection": false,
                "inferredCollection": false
              }
            ]
          },
          {
            "column": [
              {
                "path": "family",
                "name": "family",
                "type": "string",
                "collection": false,
                "inferredCollection": false
              }
            ],
            "forEachOrNull": "name"
          }
        ],
        "constMap": {},
        "allColumns": {
          "id": {
            "path": "id",
            "name": "id",
            "type": "id",
            "collection": false,
            "inferredCollection": false
          },
          "family": {
            "path": "family",
            "name": "family",
            "type": "string",
            "collection": false,
            "inferredCollection": false
          }
        }
      },
      "expect": [
        {
          "id": "pt1",
          "family": "F1.1"
        },
        {
          "id": "pt1",
          "family": "F1.2"
        },
        {
          "id": "pt2",
          "family": "F2.1"
        },
        {
          "id": "pt2",
          "family": "F2.2"
        },
        {
          "id": "pt3"
        }
      ],
      "result": {
        "passed": true
      }
    },
    {
      "title": "forEach: empty",
      "view": {
        "resource": "Patient",
        "select": [
          {
            "column": [
              {
                "path": "id",
                "name": "id",
                "type": "id",
                "collection": false,
                "inferredCollection": false
              }
            ]
          },
          {
            "column": [
              {
                "path": "value",
                "name": "value",
                "type": "string",
                "collection": false,
                "inferredCollection": false
              }
            ],
            "forEach": "identifier"
          }
        ],
        "constMap": {},
        "allColumns": {
          "id": {
            "path": "id",
            "name": "id",
            "type": "id",
            "collection": false,
            "inferredCollection": false
          },
          "value": {
            "path": "value",
            "name": "value",
            "type": "string",
            "collection": false,
            "inferredCollection": false
          }
        }
      },
      "expect": [],
      "result": {
        "passed": true
      }
    },
    {
      "title": "forEach: two on the same level",
      "view": {
        "resource": "Patient",
        "select": [
          {
            "column": [
              {
                "path": "name.family",
                "name": "cont_family",
                "type": "string",
                "collection": false,
                "inferredCollection": false
              }
            ],
            "forEach": "contact"
          },
          {
            "column": [
              {
                "path": "family",
                "name": "pat_family",
                "type": "string",
                "collection": false,
                "inferredCollection": false
              }
            ],
            "forEach": "name"
          }
        ],
        "constMap": {},
        "allColumns": {
          "cont_family": {
            "path": "name.family",
            "name": "cont_family",
            "type": "string",
            "collection": false,
            "inferredCollection": false
          },
          "pat_family": {
            "path": "family",
            "name": "pat_family",
            "type": "string",
            "collection": false,
            "inferredCollection": false
          }
        }
      },
      "expect": [
        {
          "pat_family": "F1.1",
          "cont_family": "FC1.1"
        },
        {
          "pat_family": "F1.1",
          "cont_family": "FC1.2"
        },
        {
          "pat_family": "F1.2",
          "cont_family": "FC1.1"
        },
        {
          "pat_family": "F1.2",
          "cont_family": "FC1.2"
        }
      ],
      "result": {
        "passed": true
      }
    },
    {
      "title": "forEach: two on the same level (empty result)",
      "view": {
        "resource": "Patient",
        "select": [
          {
            "column": [
              {
                "path": "id",
                "name": "id",
                "type": "id",
                "collection": false,
                "inferredCollection": false
              }
            ]
          },
          {
            "column": [
              {
                "path": "value",
                "name": "value",
                "type": "string",
                "collection": false,
                "inferredCollection": false
              }
            ],
            "forEach": "identifier"
          },
          {
            "column": [
              {
                "path": "family",
                "name": "family",
                "type": "string",
                "collection": false,
                "inferredCollection": false
              }
            ],
            "forEach": "name"
          }
        ],
        "constMap": {},
        "allColumns": {
          "id": {
            "path": "id",
            "name": "id",
            "type": "id",
            "collection": false,
            "inferredCollection": false
          },
          "value": {
            "path": "value",
            "name": "value",
            "type": "string",
            "collection": false,
            "inferredCollection": false
          },
          "family": {
            "path": "family",
            "name": "family",
            "type": "string",
            "collection": false,
            "inferredCollection": false
          }
        }
      },
      "expect": [],
      "result": {
        "passed": true
      }
    },
    {
      "title": "forEachOrNull: null case",
      "view": {
        "resource": "Patient",
        "select": [
          {
            "column": [
              {
                "path": "id",
                "name": "id",
                "type": "id",
                "collection": false,
                "inferredCollection": false
              }
            ]
          },
          {
            "column": [
              {
                "path": "value",
                "name": "value",
                "type": "string",
                "collection": false,
                "inferredCollection": false
              }
            ],
            "forEachOrNull": "identifier"
          }
        ],
        "constMap": {},
        "allColumns": {
          "id": {
            "path": "id",
            "name": "id",
            "type": "id",
            "collection": false,
            "inferredCollection": false
          },
          "value": {
            "path": "value",
            "name": "value",
            "type": "string",
            "collection": false,
            "inferredCollection": false
          }
        }
      },
      "expect": [
        {
          "id": "pt1"
        },
        {
          "id": "pt2"
        },
        {
          "id": "pt3"
        }
      ],
      "result": {
        "passed": true
      }
    },
    {
      "title": "forEach and forEachOrNull on the same level",
      "view": {
        "resource": "Patient",
        "select": [
          {
            "column": [
              {
                "path": "id",
                "name": "id",
                "type": "id",
                "collection": false,
                "inferredCollection": false
              }
            ]
          },
          {
            "column": [
              {
                "path": "value",
                "name": "value",
                "type": "string",
                "collection": false,
                "inferredCollection": false
              }
            ],
            "forEachOrNull": "identifier"
          },
          {
            "column": [
              {
                "path": "family",
                "name": "family",
                "type": "string",
                "collection": false,
                "inferredCollection": false
              }
            ],
            "forEach": "name"
          }
        ],
        "constMap": {},
        "allColumns": {
          "id": {
            "path": "id",
            "name": "id",
            "type": "id",
            "collection": false,
            "inferredCollection": false
          },
          "value": {
            "path": "value",
            "name": "value",
            "type": "string",
            "collection": false,
            "inferredCollection": false
          },
          "family": {
            "path": "family",
            "name": "family",
            "type": "string",
            "collection": false,
            "inferredCollection": false
          }
        }
      },
      "expect": [
        {
          "id": "pt1",
          "family": "F1.1"
        },
        {
          "id": "pt1",
          "family": "F1.2"
        },
        {
          "id": "pt2",
          "family": "F2.1"
        },
        {
          "id": "pt2",
          "family": "F2.2"
        }
      ],
      "result": {
        "passed": true
      }
    },
    {
      "title": "nested forEach",
      "view": {
        "resource": "Patient",
        "select": [
          {
            "column": [
              {
                "path": "id",
                "name": "id",
                "type": "id",
                "collection": false,
                "inferredCollection": false
              }
            ]
          },
          {
            "select": [
              {
                "column": [
                  {
                    "path": "telecom.system",
                    "name": "contact_type",
                    "type": "code",
                    "collection": false,
                    "inferredCollection": false
                  }
                ]
              },
              {
                "column": [
                  {
                    "path": "$this",
                    "name": "name",
                    "type": "string",
                    "collection": false,
                    "inferredCollection": false
                  }
                ],
                "forEach": "name.given"
              }
            ],
            "forEach": "contact"
          }
        ],
        "constMap": {},
        "allColumns": {
          "id": {
            "path": "id",
            "name": "id",
            "type": "id",
            "collection": false,
            "inferredCollection": false
          },
          "contact_type": {
            "path": "telecom.system",
            "name": "contact_type",
            "type": "code",
            "collection": false,
            "inferredCollection": false
          },
          "name": {
            "path": "$this",
            "name": "name",
            "type": "string",
            "collection": false,
            "inferredCollection": false
          }
        }
      },
      "expect": [
        {
          "contact_type": "phone",
          "name": "N1",
          "id": "pt1"
        },
        {
          "contact_type": "phone",
          "name": "N1`",
          "id": "pt1"
        },
        {
          "contact_type": "email",
          "name": "N2",
          "id": "pt1"
        }
      ],
      "result": {
        "passed": true
      }
    },
    {
      "title": "nested forEach: select & column",
      "view": {
        "resource": "Patient",
        "select": [
          {
            "column": [
              {
                "path": "id",
                "name": "id",
                "type": "id",
                "collection": false,
                "inferredCollection": false
              }
            ]
          },
          {
            "column": [
              {
                "path": "telecom.system",
                "name": "contact_type",
                "type": "code",
                "collection": false,
                "inferredCollection": false
              }
            ],
            "select": [
              {
                "column": [
                  {
                    "path": "$this",
                    "name": "name",
                    "type": "string",
                    "collection": false,
                    "inferredCollection": false
                  }
                ],
                "forEach": "name.given"
              }
            ],
            "forEach": "contact"
          }
        ],
        "constMap": {},
        "allColumns": {
          "id": {
            "path": "id",
            "name": "id",
            "type": "id",
            "collection": false,
            "inferredCollection": false
          },
          "contact_type": {
            "path": "telecom.system",
            "name": "contact_type",
            "type": "code",
            "collection": false,
            "inferredCollection": false
          },
          "name": {
            "path": "$this",
            "name": "name",
            "type": "string",
            "collection": false,
            "inferredCollection": false
          }
        }
      },
      "expect": [
        {
          "contact_type": "phone",
          "name": "N1",
          "id": "pt1"
        },
        {
          "contact_type": "phone",
          "name": "N1`",
          "id": "pt1"
        },
        {
          "contact_type": "email",
          "name": "N2",
          "id": "pt1"
        }
      ],
      "result": {
        "passed": true
      }
    },
    {
      "title": "forEachOrNull & unionAll on the same level",
      "view": {
        "resource": "Patient",
        "select": [
          {
            "column": [
              {
                "path": "id",
                "name": "id",
                "type": "id",
                "collection": false,
                "inferredCollection": false
              }
            ]
          },
          {
            "forEachOrNull": "contact",
            "unionAll": [
              {
                "column": [
                  {
                    "path": "name.family",
                    "name": "name",
                    "type": "string",
                    "collection": false,
                    "inferredCollection": false
                  }
                ]
              },
              {
                "column": [
                  {
                    "path": "$this",
                    "name": "name",
                    "type": "string",
                    "collection": false,
                    "inferredCollection": false
                  }
                ],
                "forEach": "name.given"
              }
            ]
          }
        ],
        "constMap": {},
        "allColumns": {
          "id": {
            "path": "id",
            "name": "id",
            "type": "id",
            "collection": false,
            "inferredCollection": false
          },
          "name": {
            "path": "name.family",
            "name": "name",
            "type": "string",
            "collection": false,
            "inferredCollection": false
          }
        }
      },
      "expect": [
        {
          "id": "pt1",
          "name": "FC1.1"
        },
        {
          "id": "pt1",
          "name": "N1"
        },
        {
          "id": "pt1",
          "name": "N1`"
        },
        {
          "id": "pt1",
          "name": "FC1.2"
        },
        {
          "id": "pt1",
          "name": "N2"
        },
        {
          "id": "pt2"
        },
        {
          "id": "pt3"
        }
      ],
      "result": {
        "passed": true
      }
    },
    {
      "title": "forEach & unionAll on the same level",
      "view": {
        "resource": "Patient",
        "select": [
          {
            "column": [
              {
                "path": "id",
                "name": "id",
                "type": "id",
                "collection": false,
                "inferredCollection": false
              }
            ]
          },
          {
            "forEach": "contact",
            "unionAll": [
              {
                "column": [
                  {
                    "path": "name.family",
                    "name": "name",
                    "type": "string",
                    "collection": false,
                    "inferredCollection": false
                  }
                ]
              },
              {
                "column": [
                  {
                    "path": "$this",
                    "name": "name",
                    "type": "string",
                    "collection": false,
                    "inferredCollection": false
                  }
                ],
                "forEach": "name.given"
              }
            ]
          }
        ],
        "constMap": {},
        "allColumns": {
          "id": {
            "path": "id",
            "name": "id",
            "type": "id",
            "collection": false,
            "inferredCollection": false
          },
          "name": {
            "path": "name.family",
            "name": "name",
            "type": "string",
            "collection": false,
            "inferredCollection": false
          }
        }
      },
      "expect": [
        {
          "id": "pt1",
          "name": "FC1.1"
        },
        {
          "id": "pt1",
          "name": "N1"
        },
        {
          "id": "pt1",
          "name": "N1`"
        },
        {
          "id": "pt1",
          "name": "FC1.2"
        },
        {
          "id": "pt1",
          "name": "N2"
        }
      ],
      "result": {
        "passed": true
      }
    },
    {
      "title": "forEach & unionAll & column & select on the same level",
      "view": {
        "resource": "Patient",
        "select": [
          {
            "column": [
              {
                "path": "id",
                "name": "id",
                "type": "id",
                "collection": false,
                "inferredCollection": false
              }
            ]
          },
          {
            "column": [
              {
                "path": "telecom.system",
                "name": "tel_system",
                "type": "code",
                "collection": false,
                "inferredCollection": false
              }
            ],
            "select": [
              {
                "column": [
                  {
                    "path": "gender",
                    "name": "gender",
                    "type": "code",
                    "collection": false,
                    "inferredCollection": false
                  }
                ]
              }
            ],
            "forEach": "contact",
            "unionAll": [
              {
                "column": [
                  {
                    "path": "name.family",
                    "name": "name",
                    "type": "string",
                    "collection": false,
                    "inferredCollection": false
                  }
                ]
              },
              {
                "column": [
                  {
                    "path": "$this",
                    "name": "name",
                    "type": "string",
                    "collection": false,
                    "inferredCollection": false
                  }
                ],
                "forEach": "name.given"
              }
            ]
          }
        ],
        "constMap": {},
        "allColumns": {
          "id": {
            "path": "id",
            "name": "id",
            "type": "id",
            "collection": false,
            "inferredCollection": false
          },
          "tel_system": {
            "path": "telecom.system",
            "name": "tel_system",
            "type": "code",
            "collection": false,
            "inferredCollection": false
          },
          "gender": {
            "path": "gender",
            "name": "gender",
            "type": "code",
            "collection": false,
            "inferredCollection": false
          },
          "name": {
            "path": "name.family",
            "name": "name",
            "type": "string",
            "collection": false,
            "inferredCollection": false
          }
        }
      },
      "expect": [
        {
          "id": "pt1",
          "name": "FC1.1",
          "tel_system": "phone"
        },
        {
          "id": "pt1",
          "name": "N1",
          "tel_system": "phone"
        },
        {
          "id": "pt1",
          "name": "N1`",
          "tel_system": "phone"
        },
        {
          "id": "pt1",
          "name": "FC1.2",
          "tel_system": "email",
          "gender": "unknown"
        },
        {
          "id": "pt1",
          "name": "N2",
          "tel_system": "email",
          "gender": "unknown"
        }
      ],
      "result": {
        "passed": true
      }
    },
    {
      "title": "forEachOrNull & unionAll & column & select on the same level",
      "view": {
        "resource": "Patient",
        "select": [
          {
            "column": [
              {
                "path": "id",
                "name": "id",
                "type": "id",
                "collection": false,
                "inferredCollection": false
              }
            ]
          },
          {
            "column": [
              {
                "path": "telecom.system",
                "name": "tel_system",
                "type": "code",
                "collection": false,
                "inferredCollection": false
              }
            ],
            "select": [
              {
                "column": [
                  {
                    "path": "gender",
                    "name": "gender",
                    "type": "code",
                    "collection": false,
                    "inferredCollection": false
                  }
                ]
              }
            ],
            "forEachOrNull": "contact",
            "unionAll": [
              {
                "column": [
                  {
                    "path": "name.family",
                    "name": "name",
                    "type": "string",
                    "collection": false,
                    "inferredCollection": false
                  }
                ]
              },
              {
                "column": [
                  {
                    "path": "$this",
                    "name": "name",
                    "type": "string",
                    "collection": false,
                    "inferredCollection": false
                  }
                ],
                "forEach": "name.given"
              }
            ]
          }
        ],
        "constMap": {},
        "allColumns": {
          "id": {
            "path": "id",
            "name": "id",
            "type": "id",
            "collection": false,
            "inferredCollection": false
          },
          "tel_system": {
            "path": "telecom.system",
            "name": "tel_system",
            "type": "code",
            "collection": false,
            "inferredCollection": false
          },
          "gender": {
            "path": "gender",
            "name": "gender",
            "type": "code",
            "collection": false,
            "inferredCollection": false
          },
          "name": {
            "path": "name.family",
            "name": "name",
            "type": "string",
            "collection": false,
            "inferredCollection": false
          }
        }
      },
      "expect": [
        {
          "id": "pt1",
          "name": "FC1.1",
          "tel_system": "phone"
        },
        {
          "id": "pt1",
          "name": "N1",
          "tel_system": "phone"
        },
        {
          "id": "pt1",
          "name": "N1`",
          "tel_system": "phone"
        },
        {
          "id": "pt1",
          "name": "FC1.2",
          "tel_system": "email",
          "gender": "unknown"
        },
        {
          "id": "pt1",
          "name": "N2",
          "tel_system": "email",
          "gender": "unknown"
        },
        {
          "id": "pt2"
        },
        {
          "id": "pt3"
        }
      ],
      "result": {
        "passed": true
      }
    }
  ]
},
{
  "title": "fn_first",
  "resources": [
    {
      "resourceType": "Patient",
      "name": [
        {
          "use": "official",
          "family": "f1",
          "given": [
            "g1.1",
            "g1.2"
          ]
        },
        {
          "use": "usual",
          "given": [
            "g2.1"
          ]
        },
        {
          "use": "maiden",
          "family": "f3",
          "given": [
            "g3.1",
            "g3.2"
          ],
          "period": {
            "end": "2002"
          }
        }
      ]
    }
  ],
  "tests": [
    {
      "title": "table level first()",
      "view": {
        "resource": "Patient",
        "select": [
          {
            "column": [
              {
                "path": "name.first().use",
                "name": "use",
                "type": "code",
                "collection": false,
                "inferredCollection": false
              }
            ]
          }
        ],
        "constMap": {},
        "allColumns": {
          "use": {
            "path": "name.first().use",
            "name": "use",
            "type": "code",
            "collection": false,
            "inferredCollection": false
          }
        }
      },
      "expect": [
        {
          "use": "official"
        }
      ],
      "result": {
        "passed": true
      }
    },
    {
      "title": "table and field level first()",
      "view": {
        "resource": "Patient",
        "select": [
          {
            "column": [
              {
                "path": "name.first().given.first()",
                "name": "given",
                "type": "string",
                "collection": false,
                "inferredCollection": false
              }
            ]
          }
        ],
        "constMap": {},
        "allColumns": {
          "given": {
            "path": "name.first().given.first()",
            "name": "given",
            "type": "string",
            "collection": false,
            "inferredCollection": false
          }
        }
      },
      "expect": [
        {
          "given": "g1.1"
        }
      ],
      "result": {
        "passed": true
      }
    }
  ]
},
{
  "title": "fn_reference_keys",
  "resources": [
    {
      "resourceType": "Patient",
      "id": "p1",
      "link": [
        {
          "other": {
            "reference": "Patient/p1"
          }
        }
      ]
    },
    {
      "resourceType": "Patient",
      "id": "p2",
      "link": [
        {
          "other": {
            "reference": "Patient/p3"
          }
        }
      ]
    }
  ],
  "tests": [
    {
      "title": "getReferenceKey result matches getResourceKey without type specifier",
      "view": {
        "resource": "Patient",
        "select": [
          {
            "column": [
              {
                "path": "getResourceKey()",
                "name": "resourceKey",
                "collection": false,
                "inferredCollection": false
              },
              {
                "path": "link.other.getReferenceKey()",
                "name": "referenceKey",
                "collection": false,
                "inferredCollection": false
              }
            ]
          }
        ],
        "constMap": {},
        "allColumns": {
          "resourceKey": {
            "path": "getResourceKey()",
            "name": "resourceKey",
            "collection": false,
            "inferredCollection": false
          },
          "referenceKey": {
            "path": "link.other.getReferenceKey()",
            "name": "referenceKey",
            "collection": false,
            "inferredCollection": false
          }
        }
      },
      "expect": [
        {
          "resourceKey": "p1",
          "referenceKey": "p1"
        },
        {
          "resourceKey": "p2",
          "referenceKey": "p3"
        }
      ],
      "result": {
        "passed": true
      }
    },
    {
      "title": "getReferenceKey result matches getResourceKey with right type specifier",
      "view": {
        "resource": "Patient",
        "select": [
          {
            "column": [
              {
                "path": "getResourceKey()",
                "name": "resourceKey",
                "collection": false,
                "inferredCollection": false
              },
              {
                "path": "link.other.getReferenceKey(Patient)",
                "name": "referenceKey",
                "collection": false,
                "inferredCollection": false
              }
            ]
          }
        ],
        "constMap": {},
        "allColumns": {
          "resourceKey": {
            "path": "getResourceKey()",
            "name": "resourceKey",
            "collection": false,
            "inferredCollection": false
          },
          "referenceKey": {
            "path": "link.other.getReferenceKey(Patient)",
            "name": "referenceKey",
            "collection": false,
            "inferredCollection": false
          }
        }
      },
      "expect": [
        {
          "resourceKey": "p1",
          "referenceKey": "p1"
        },
        {
          "resourceKey": "p2",
          "referenceKey": "p3"
        }
      ],
      "result": {
        "passed": true
      }
    },
    {
      "title": "getReferenceKey result matches getResourceKey with wrong type specifier",
      "view": {
        "resource": "Patient",
        "select": [
          {
            "column": [
              {
                "path": "link.other.getReferenceKey(Observation)",
                "name": "referenceKey",
                "type": "string",
                "collection": false,
                "inferredCollection": false
              },
              {
                "path": "getResourceKey()",
                "name": "resourceKey",
                "type": "string",
                "collection": false,
                "inferredCollection": false
              }
            ]
          }
        ],
        "constMap": {},
        "allColumns": {
          "referenceKey": {
            "path": "link.other.getReferenceKey(Observation)",
            "name": "referenceKey",
            "type": "string",
            "collection": false,
            "inferredCollection": false
          },
          "resourceKey": {
            "path": "getResourceKey()",
            "name": "resourceKey",
            "type": "string",
            "collection": false,
            "inferredCollection": false
          }
        }
      },
      "expect": [
        {
          "resourceKey": "p1"
        },
        {
          "resourceKey": "p2"
        }
      ],
      "result": {
        "passed": true
      }
    }
  ]
},
{
  "title": "collection",
  "resources": [
    {
      "resourceType": "Patient",
      "id": "pt1",
      "name": [
        {
          "use": "official",
          "family": "f1.1",
          "given": [
            "g1.1"
          ]
        },
        {
          "family": "f1.2",
          "given": [
            "g1.2",
            "g1.3"
          ]
        }
      ],
      "gender": "male",
      "birthDate": "1950-01-01",
      "address": [
        {
          "city": "c1"
        }
      ]
    },
    {
      "resourceType": "Patient",
      "id": "pt2",
      "name": [
        {
          "family": "f2.1",
          "given": [
            "g2.1"
          ]
        },
        {
          "use": "official",
          "family": "f2.2",
          "given": [
            "g2.2",
            "g2.3"
          ]
        }
      ],
      "gender": "female",
      "birthDate": "1950-01-01"
    }
  ],
  "tests": [
    {
      "title": "fail when 'collection' is not true",
      "view": {
        "resource": "Patient",
        "select": [
          {
            "column": [
              {
                "path": "id",
                "name": "id",
                "type": "id",
                "collection": false,
                "inferredCollection": false
              },
              {
                "path": "name.family",
                "name": "last_name",
                "type": "string",
                "collection": false,
                "inferredCollection": false
              },
              {
                "path": "name.given",
                "name": "first_name",
                "type": "string",
                "collection": true,
                "inferredCollection": false
              }
            ]
          }
        ],
        "constMap": {},
        "allColumns": {
          "id": {
            "path": "id",
            "name": "id",
            "type": "id",
            "collection": false,
            "inferredCollection": false
          },
          "last_name": {
            "path": "name.family",
            "name": "last_name",
            "type": "string",
            "collection": false,
            "inferredCollection": false
          },
          "first_name": {
            "path": "name.given",
            "name": "first_name",
            "type": "string",
            "collection": true,
            "inferredCollection": false
          }
        }
      },
      "expectError": true
    },
    {
      "title": "collection = true",
      "view": {
        "resource": "Patient",
        "select": [
          {
            "column": [
              {
                "path": "id",
                "name": "id",
                "type": "id",
                "collection": false,
                "inferredCollection": false
              },
              {
                "path": "name.family",
                "name": "last_name",
                "type": "string",
                "collection": true,
                "inferredCollection": false
              },
              {
                "path": "name.given",
                "name": "first_name",
                "type": "string",
                "collection": true,
                "inferredCollection": false
              }
            ]
          }
        ],
        "constMap": {},
        "allColumns": {
          "id": {
            "path": "id",
            "name": "id",
            "type": "id",
            "collection": false,
            "inferredCollection": false
          },
          "last_name": {
            "path": "name.family",
            "name": "last_name",
            "type": "string",
            "collection": true,
            "inferredCollection": false
          },
          "first_name": {
            "path": "name.given",
            "name": "first_name",
            "type": "string",
            "collection": true,
            "inferredCollection": false
          }
        }
      },
      "expect": [
        {
          "id": "pt1",
          "last_name": [
            "f1.1",
            "f1.2"
          ],
          "first_name": [
            "g1.1",
            "g1.2",
            "g1.3"
          ]
        },
        {
          "id": "pt2",
          "last_name": [
            "f2.1",
            "f2.2"
          ],
          "first_name": [
            "g2.1",
            "g2.2",
            "g2.3"
          ]
        }
      ],
      "result": {
        "passed": true
      }
    },
    {
      "title": "collection = false relative to forEach parent",
      "view": {
        "resource": "Patient",
        "select": [
          {
            "column": [
              {
                "path": "id",
                "name": "id",
                "type": "id",
                "collection": false,
                "inferredCollection": false
              }
            ],
            "select": [
              {
                "column": [
                  {
                    "path": "family",
                    "name": "last_name",
                    "type": "string",
                    "collection": false,
                    "inferredCollection": false
                  },
                  {
                    "path": "given",
                    "name": "first_name",
                    "type": "string",
                    "collection": true,
                    "inferredCollection": false
                  }
                ],
                "forEach": "name"
              }
            ]
          }
        ],
        "constMap": {},
        "allColumns": {
          "id": {
            "path": "id",
            "name": "id",
            "type": "id",
            "collection": false,
            "inferredCollection": false
          },
          "last_name": {
            "path": "family",
            "name": "last_name",
            "type": "string",
            "collection": false,
            "inferredCollection": false
          },
          "first_name": {
            "path": "given",
            "name": "first_name",
            "type": "string",
            "collection": true,
            "inferredCollection": false
          }
        }
      },
      "expect": [
        {
          "id": "pt1",
          "last_name": "f1.1",
          "first_name": [
            "g1.1"
          ]
        },
        {
          "id": "pt1",
          "last_name": "f1.2",
          "first_name": [
            "g1.2",
            "g1.3"
          ]
        },
        {
          "id": "pt2",
          "last_name": "f2.1",
          "first_name": [
            "g2.1"
          ]
        },
        {
          "id": "pt2",
          "last_name": "f2.2",
          "first_name": [
            "g2.2",
            "g2.3"
          ]
        }
      ],
      "result": {
        "passed": true
      }
    },
    {
      "title": "collection = false relative to forEachOrNull parent",
      "view": {
        "resource": "Patient",
        "select": [
          {
            "column": [
              {
                "path": "id",
                "name": "id",
                "type": "id",
                "collection": false,
                "inferredCollection": false
              }
            ],
            "select": [
              {
                "column": [
                  {
                    "path": "family",
                    "name": "last_name",
                    "type": "string",
                    "collection": false,
                    "inferredCollection": false
                  },
                  {
                    "path": "given",
                    "name": "first_name",
                    "type": "string",
                    "collection": true,
                    "inferredCollection": false
                  }
                ],
                "forEach": "name"
              }
            ]
          }
        ],
        "constMap": {},
        "allColumns": {
          "id": {
            "path": "id",
            "name": "id",
            "type": "id",
            "collection": false,
            "inferredCollection": false
          },
          "last_name": {
            "path": "family",
            "name": "last_name",
            "type": "string",
            "collection": false,
            "inferredCollection": false
          },
          "first_name": {
            "path": "given",
            "name": "first_name",
            "type": "string",
            "collection": true,
            "inferredCollection": false
          }
        }
      },
      "expect": [
        {
          "id": "pt1",
          "last_name": "f1.1",
          "first_name": [
            "g1.1"
          ]
        },
        {
          "id": "pt1",
          "last_name": "f1.2",
          "first_name": [
            "g1.2",
            "g1.3"
          ]
        },
        {
          "id": "pt2",
          "last_name": "f2.1",
          "first_name": [
            "g2.1"
          ]
        },
        {
          "id": "pt2",
          "last_name": "f2.2",
          "first_name": [
            "g2.2",
            "g2.3"
          ]
        }
      ],
      "result": {
        "passed": true
      }
    }
  ]
}]