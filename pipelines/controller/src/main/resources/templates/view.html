<!doctype html>
<html>
<head>

  <title>
    FHIR Analytics Pipelines Control Panel
  </title>

  <link rel="stylesheet" type="text/css" href="../static/style.css"
        th:href="@{/style.css}">
  <!-- Bootstrap core CSS -->
  <link href="../static/bootstrap-5.0.2-dist/css/bootstrap.min.css"
        th:href="@{/bootstrap-5.0.2-dist/css/bootstrap.min.css}" rel="stylesheet">
  <script src="../static/bootstrap-5.0.2-dist/js/bootstrap.min.js"
          th:src="@{/bootstrap-5.0.2-dist/js/bootstrap.min.js}"></script>

  <script>
    function changeVisibility(elemId, makeVisible) {
      var elem = document.getElementById(elemId);
      if (makeVisible) {
        elem.style.display = 'block';
      } else {
        elem.style.display = 'none';
      }
    }

    function submitView() {
      console.log('Submitting the view ...');
      changeVisibility('viewError', false);
      var xhr = new XMLHttpRequest();
      xhr.open("POST", '/testView', true);
      xhr.onreadystatechange = function() {
        changeVisibility('viewWait', false);
        if (this.readyState === XMLHttpRequest.DONE && this.status === 200) {
          console.log('View generation succeeded.');
          document.getElementById('viewOutput').innerHTML = this.response;
        }
        // Handle errors.
        if (this.readyState === XMLHttpRequest.DONE && this.status != 200) {
          console.log('View generation failed: ' + this.response);
          document.getElementById('viewError').innerHTML = this.response;
          changeVisibility('viewError', true);
        }
      }
      formData = new FormData();
      formData.append('viewDef', document.getElementById('inputView').value);
      formData.append('resource', document.getElementById('inputResource').value);
      changeVisibility('viewWait', true);
      xhr.send(formData);
    }
  </script>
</head>

<body>
<div class="container-fluid">
    <div class="row m-4">
      <div class="col text-center">
        <button
            data-bs-toggle="tooltip"
            data-bs-placement="top"
            data-bs-trigger="hover"
            title="Use Submit to apply the ViewDefinition on the FHIR resource."
            type="submit"
            onclick="submitView()"
            class="btn btn-primary">Submit</button>
      </div>
    </div>
    <div class="row">
      <div class="alert alert-info alert-dismissible fade show" id="viewWait" style="display:none">
        <!-- Spinner -->
        <div class="lds-default">
          <div></div><div></div><div></div><div></div>
          <div></div><div></div><div></div><div></div>
          <div></div><div></div><div></div><div></div>
        </div>
        The view is being generated ...
      </div>
      <div class="alert alert-danger alert-dismissible fade show" id="viewError" style="display:none; color:red">
        Error in generating the view!
        <!-- button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button -->
      </div>
    </div>
    <div class="row mb-4">
      <!-- Note each row is divided into 12 cells, so a col-2 spans two cells, ess:
        https://getbootstrap.com/docs/5.0/layout/grid/ -->
      <div class="col-12">
        <div id="outputHelp" class="form-text">
          The generated view will be displayed here.
        </div>
        <table class="table table-striped table-bordered" id="viewOutput"
               aria-describedby="outputHelp">
        </table>
      </div>
    </div>
    <div class="row">
      <div class="col">
        <label for="inputView" class="form-label">Input ViewDefinition</label>
      </div>
      <div class="col">
        <label for="inputResource" class="form-label">Input Resource</label>
      </div>
    </div>
    <div class="row">
      <div class="col">
        <div id="viewHelp" class="form-text">
          Enter a ViewDefinition to be applied on the given FHIR resource on the right.
        </div>
        <textarea class="form-control" id="inputView" aria-describedby="viewHelp"
                  rows="40"></textarea>
      </div>
      <div class="col">
        <div id="resourceHelp" class="form-text">
          Enter a valid FHIR resource.
        </div>
        <textarea class="form-control" id="inputResource" aria-describedby="viewHelp"
                  rows="40"></textarea>
      </div>
    </div>
</div>
</body>
</html>